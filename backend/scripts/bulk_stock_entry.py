"""
Toplu Stok Girişi Script'i
===========================
QR kodlarından ilaç bilgilerini parse eder ve ana depoya stok girişi yapar.
"""

import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

import asyncio
import json
import uuid
from datetime import datetime
from typing import Dict, List
import re

# İlaç veritabanını yükle
MEDICATIONS_FILE = os.path.join(os.path.dirname(os.path.dirname(__file__)), 'data', 'medications_barcode.json')

def load_medications_db():
    """İlaç barkod veritabanını yükle"""
    try:
        with open(MEDICATIONS_FILE, 'r', encoding='utf-8') as f:
            return json.load(f)
    except Exception as e:
        print(f"[HATA] İlaç veritabanı yüklenemedi: {e}")
        return {}

def parse_datamatrix(barcode: str) -> Dict:
    """
    GS1 DataMatrix karekodunu parse et
    
    AI Kodları:
    - 01: GTIN (14 hane)
    - 21: Seri Numarası (değişken uzunluk)
    - 10: Parti/Lot Numarası (değişken uzunluk)
    - 17: Son Kullanma Tarihi (YYMMDD - 6 hane)
    """
    result = {
        "gtin": None,
        "serial_number": None,
        "lot_number": None,
        "expiry_date": None,
        "expiry_date_str": None,
        "raw": barcode
    }
    
    if not barcode:
        return result
    
    barcode = barcode.strip()
    
    # Basit EAN-13 barkod mu kontrol et (13 haneli)
    if len(barcode) == 13 and barcode.isdigit():
        result["gtin"] = barcode
        return result
    
    # 01 ile başlıyor mu kontrol et
    if barcode.startswith('01') and len(barcode) >= 16:
        # GTIN (14 hane)
        result["gtin"] = barcode[2:16]
        rest = barcode[16:]
        
        # Kalan veriyi parse et
        # 21SERIAL17YYMMDD10LOT formatı
        
        # 21 ile başlayan seri numarasını bul
        if rest.startswith('21'):
            # Sonraki AI'yı bul (17 veya 10)
            serial_end = len(rest)
            for ai in ['17', '10']:
                idx = rest.find(ai, 2)
                if idx > 2 and idx < serial_end:
                    serial_end = idx
            result["serial_number"] = rest[2:serial_end]
            rest = rest[serial_end:]
        
        # 17 ile başlayan son kullanma tarihini bul
        if '17' in rest:
            idx = rest.find('17')
            if idx >= 0 and len(rest) >= idx + 8:
                exp_str = rest[idx+2:idx+8]
                result["expiry_date_str"] = exp_str
                try:
                    year = 2000 + int(exp_str[0:2])
                    month = int(exp_str[2:4])
                    day = int(exp_str[4:6])
                    if day == 0:
                        day = 28
                    result["expiry_date"] = datetime(year, month, day)
                except:
                    pass
                rest = rest[:idx] + rest[idx+8:]
        
        # 10 ile başlayan lot numarasını bul
        if '10' in rest:
            idx = rest.find('10')
            if idx >= 0:
                lot_end = len(rest)
                for ai in ['17', '21']:
                    ai_idx = rest.find(ai, idx + 2)
                    if ai_idx > idx and ai_idx < lot_end:
                        lot_end = ai_idx
                result["lot_number"] = rest[idx+2:lot_end]
    
    return result

def get_medication_name(gtin: str, medications_db: dict) -> str:
    """GTIN'den ilaç adını bul"""
    if not gtin:
        return None
    
    # Direkt eşleşme
    if gtin in medications_db:
        return medications_db[gtin]
    
    # 13 haneli versiyonu dene (EAN-13)
    if len(gtin) == 14 and gtin.startswith('0'):
        ean13 = gtin[1:]
        if ean13 in medications_db:
            return medications_db[ean13]
    
    # Son 13 haneyi dene
    if len(gtin) > 13:
        ean13 = gtin[-13:]
        if ean13 in medications_db:
            return medications_db[ean13]
    
    return None

async def bulk_add_stock(barcodes: List[str]):
    """Toplu stok girişi yap"""
    from motor.motor_asyncio import AsyncIOMotorClient
    from dotenv import load_dotenv
    from pathlib import Path
    
    # .env dosyasını yükle
    env_path = Path(__file__).parent.parent / '.env'
    load_dotenv(env_path)
    
    mongo_url = os.environ.get('MONGO_URL', 'mongodb+srv://healmedy_user:H3alm3dy2024!@abro.lwzasyg.mongodb.net/')
    db_name = os.environ.get('DB_NAME', 'healmedy_hbys')
    
    client = AsyncIOMotorClient(mongo_url)
    db = client[db_name]
    stock_collection = db.stock
    barcode_stock_collection = db.barcode_stock
    
    medications_db = load_medications_db()
    print(f"[INFO] {len(medications_db)} ilaç veritabanından yüklendi")
    
    # Sonuçları grupla
    results = {
        "success": [],
        "already_exists": [],
        "unknown_medication": [],
        "errors": []
    }
    
    # Benzersiz GTIN'leri say
    gtin_counts = {}
    
    for barcode in barcodes:
        barcode = barcode.strip()
        if not barcode:
            continue
        
        try:
            parsed = parse_datamatrix(barcode)
            gtin = parsed.get("gtin")
            serial = parsed.get("serial_number") or f"RAW-{barcode[:20]}"
            
            # Bu karekod zaten var mı?
            existing = await barcode_stock_collection.find_one({
                "serial_number": serial,
                "gtin": gtin
            })
            
            if existing:
                results["already_exists"].append({
                    "barcode": barcode,
                    "gtin": gtin,
                    "name": existing.get("name"),
                    "location": existing.get("location")
                })
                continue
            
            # İlaç adını bul
            med_name = get_medication_name(gtin, medications_db)
            
            if not med_name:
                # Bilinmeyen ilaç
                results["unknown_medication"].append({
                    "barcode": barcode,
                    "gtin": gtin,
                    "serial": serial
                })
                med_name = f"Bilinmeyen İlaç ({gtin[-6:] if gtin else 'N/A'})"
            
            # GTIN sayısını güncelle
            if gtin:
                if gtin not in gtin_counts:
                    gtin_counts[gtin] = {"name": med_name, "count": 0}
                gtin_counts[gtin]["count"] += 1
            
            # Karekod stok kaydı oluştur
            stock_id = str(uuid.uuid4())
            barcode_stock_item = {
                "_id": stock_id,
                "gtin": gtin or "",
                "serial_number": serial,
                "lot_number": parsed.get("lot_number"),
                "expiry_date": parsed.get("expiry_date"),
                "expiry_date_str": parsed.get("expiry_date_str"),
                "name": med_name,
                "location": "merkez_depo",
                "location_detail": "Ana Depo",
                "status": "available",
                "added_at": datetime.utcnow(),
                "added_by": "bulk_import",
                "added_by_name": "Toplu İçe Aktarma",
                "raw_barcode": barcode
            }
            
            await barcode_stock_collection.insert_one(barcode_stock_item)
            
            # Ana stok collection'ına da ekle
            main_stock_item = {
                "_id": str(uuid.uuid4()),
                "name": med_name,
                "code": gtin[:8] if gtin else serial[:8],
                "gtin": gtin,
                "quantity": 1,
                "min_quantity": 1,
                "location": "merkez_depo",
                "location_detail": "Ana Depo",
                "lot_number": parsed.get("lot_number"),
                "serial_number": serial,
                "expiry_date": parsed.get("expiry_date"),
                "qr_code": stock_id,
                "unit": "adet",
                "created_at": datetime.utcnow(),
                "updated_at": datetime.utcnow(),
                "barcode_stock_id": stock_id
            }
            
            await stock_collection.insert_one(main_stock_item)
            
            results["success"].append({
                "barcode": barcode[:30] + "..." if len(barcode) > 30 else barcode,
                "gtin": gtin,
                "name": med_name,
                "serial": serial[:20] + "..." if len(serial) > 20 else serial,
                "expiry": parsed.get("expiry_date").strftime("%Y-%m-%d") if parsed.get("expiry_date") else None,
                "lot": parsed.get("lot_number")
            })
            
        except Exception as e:
            results["errors"].append({
                "barcode": barcode[:50],
                "error": str(e)
            })
    
    client.close()
    
    return results, gtin_counts

def main():
    # Karekod listesi
    barcodes = """0108699788750027212599607002003674172905311025607002
0108699788750027212599607002003670172905311025607002
0108699788750027212599607002003665172905311025607002
0108699788750027212599607002003682172905311025607002
0108699788750027212599607002003679172905311025607002
0108699788750027212599607002003666172905311025607002
0108699788750027212599607002003793172905311025607002
0108699788750027212599607002003673172905311025607002
0108699788750027212599607002003804172905311025607002
0108699788750027212599607002003668172905311025607002
0108699788750027212599607002003788172905311025607002
0108699788750027212599607002003676172905311025607002
010869960775008521100000029640051727013110220523003
010869960775008521100000029640251727013110220523003
010869960775008521100000029701491727013110220523003
010869960775008521100000029639241727013110220523003
010869968009005421I00241000974607317280331102400410003
010869968009005421I00241000974607417280331102400410003
010869968009005421I00241000974607817280331102400410003
010869968009005421I00241000974584817280331102400410003
010869968009005421I00241000974586117280331102400410003
010869968009005421I00241000974584317280331102400410003
010869968009005421I00241000974583717280331102400410003
010869968009005421I00241000974609117280331102400410003
010869968009005421I00241000974583617280331102400410003
010869968009005421I00241000974586017280331102400410003
010869968009005421I00241000974585417280331102400410003
010869968009005421I00241000974584917280331102400410003
010869968009005421I00241000974609017280331102400410003
010869968009005421I00241000974609617280331102400410003
010869885661023221C006378005633717270400104E068A
010869885661023221C006378035907917270400104E068A
010869885661023221C006378005640917270400104E068A
010869885661023221C006378005635517270400104E068A
010869885661023221C006378005640017270400104E068A
010869885661023221C006376073096217270400104E060A
010869885661023221C006378035907017270400104E068A
010868019971841621340000206293831725123110401000580
010869983275001021MEN97V4C7G50TM17290331102504015
010869983275001021MEN2GF052XM31417290331102504016
010869983275001021MENVH2H3VMWKH617281031102411073
01086995702400642158000010720792172705311025196079A
01086995702400642158000010721095172705311025196079A
01086995702400642158000010721086172705311025196079A
01086995702400642158000010720972172705311025196079A
01086995702400642158000010721051172705311025196079A
01086995702400642158000010721040172705311025196079A
01086995702400642158000009455435172703311025196043A
01086995702400642158000004721681172604301024196066A
01086995702400642158000010720784172705311025196079A
01086995702400642158000010720976172705311025196079A
01086995702400642158000010720828172705311025196079A
01086995702400642158000010720748172705311025196079A
01086995702400642158000010721104172705311025196079A
01086995702400642158000010720989172705311025196079A
01086995702400642158000010720695172705311025196079A
01086995702400642158000010720987172705311025196079A
01086995702400642158000010721001172705311025196079A
01086995702400642158000010720796172705311025196079A
01086995702400642158000010721065172705311025196079A
01086995702400642158000010721031172705311025196079A
01086995702400642158000010720958172705311025196079A
01086995702400642158000010721107172705311025196079A
01086995702400642158000010720965172705311025196079A
01086995702400642158000010720927172705311025196079A
01086995702400642158000010720984172705311025196079A
01086995702400642158000009455538172703311025196043A
01086995702400642158000010720967172705311025196079A
01086995702400642158000010721045172705311025196079A
01086995702400642158000010720810172705311025196079A
01086995702400642158000010721102172705311025196079A
01086995702400642158000010720993172705311025196079A
01086995702400642158000010720844172705311025196079A
01086995702400642158000010720855172705311025196079A
01086995702400642158000010720480172705311025196079A
01086995702400642158000010720893172705311025196079A
01086995702400642158000010720997172705311025196079A
01086995702400642158000010720918172705311025196079A
01086995702400642158000010720961172705311025196079A
01086995702400642158000010720980172705311025196079A
01086995702400642158000010720861172705311025196079A
01086995702400642158000010720934172705311025196079A
01086995702400642158000010720806172705311025196079A
01086995702400642158000010720941172705311025196079A
0108699546010028216262835042951727013110ELB01350
0108699546010028216149624783791727013110ELB01350
0108699546010028216304520480521727013110ELB01350
0108699546010028216583368651321727013110ELB01350
0108699546010028216865246237921727013110ELB01350
0108699546010028216104371173451727013110ELB01350
0108699546010028216332305914181727013110ELB01350
0108699546010028216779672845341727013110ELB01350
0108699546010028216377463692751727013110ELB01350
0108699546010028216943712427931727013110ELB01350
0108699546010028216165397239751727013110ELB01350
0108699546010028216039469160501727013110ELB01350
0108699546010028216482964823541727013110ELB01350
0108699546010028216080339664611727013110ELB01350
0108699546010028216643660166461727013110ELB01350
0108699546010028216223297234071727013110ELB01350
0108699546010028216871302970201727013110ELB01350
0108699546010028216926061734921727013110ELB01350
0108699546010028216158642953241727013110ELB01350
0108699546010028216213097713381727013110ELB01350
0108699546010028216570740679841727013110ELB01350
0108699546010028216402664675991726073110DLB04555
0108699546010028216671605027011727013110ELB01350
0108699546010028216634129666301727013110ELB01350
0108699546010028216584742171631727013110ELB01350
0108699546010028216917679386651727013110ELB01350
0108699546010028216037954290181727013110ELB01350
0108699546010028216946949851771727013110ELB01350
0108699546010028216779740921601727013110ELB01350
0108699546010028216874002820911727013110ELB01350
0108699546010028216836774762901727013110ELB01350
0108699546010028216567491723421727013110ELB01350
0108699546010028216782642732211727013110ELB01350
0108699546010028216665707980331726073110DLB04555
0108699546010028216176882870451727013110ELB01350
0108699546010028216563655277931727013110ELB01350
0108699546010028216043284413811727013110ELB01350
0108699546010028216242989759371727013110ELB01350
0108699546010028216198365069081727013110ELB01350
0108699546010028216930060532811727013110ELB01350
0108699546010028216626591710901727013110ELB01350
0108699546010028216672464176471727013110ELB01350
0108699546010028216533531799061727013110ELB01350
0108699546010028216745069060291727013110ELB01350
0108699546010028216681605528621727013110ELB01350
0108699546010028216073665124961727013110ELB01350
0108699546010028216828377119131727013110ELB01350
0108699546010028216258875685421727013110ELB01350
0108699546010028216785800075311727013110ELB01350
010869960775002321100000013302831726093010210513004
010869960775002321100000013177781726093010210513004
010869960775002321100000013303341726093010210513004
010869960775001621100000006323911727103110220514001
010869960775001621100000006323741727103110220514001
010869960775001621100000006323711727103110220514001
010869960775001621100000006323721727103110220514001
010869960775001621100000006323901727103110220514001
010869960775001621100000006324201727103110220514001
010869960775001621100000006323601727103110220514001
010869960775001621100000006323671727103110220514001
010869960775001621100000006324191727103110220514001
010869960775001621100000006323761727103110220514001
010869951638031121739000044076041726103110AA23472
010869951638031121739000044076011726103110AA23472
010869951638031121739000044076061726103110AA23472
010869951638031121739000044149811726103110AA23472
010869951638031121739000044076111726103110AA23472
010869951638031121739000044149861726103110AA23472
010869951638031121739000044076051726103110AA23472
010869951638031121739000044149761726103110AA23472
010869951638031121739000044076091726103110AA23472
010869951638031121739000044149841726103110AA23472
010869951638031121739000044076101726103110AA23472
010869951638031121739000044149831726103110AA23472
010869951638031121739000044076031726103110AA23472
010868142801190221A00000001475561726022810AA20024
010868142801190221A00000001475501726022810AA20024
010868142801190221A00000001466351726022810AA20024
010868142801190221A00000001475521726022810AA20024
010869951138020021ST0000002089521727103110A19642
010869951138020021ST0000002456791727103110A19642
0108680712270230210000000253126217270131102502021B
0108680712270230210000000253125517270131102502021B
0108680712270230210000000253126017270131102502021B
0108680712270230210000000253125917270131102502021B
0108680712270230210000000253124317270131102502021B
0108680712270230210000000253124817270131102502021B
0108680712270230210000000253124417270131102502021B
0108680712270230210000000253123817270131102502021B
0108680712270230210000000253124517270131102502021B
0108680712270230210000000253124017270131102502021B
0108680712270230210000000253125117270131102502021B
0108680712270230210000000253124217270131102502021B
0108680712270230210000000253124717270131102502021B
0108680712270230210000000253125617270131102502021B
0108680712270230210000000253123917270131102502021B
0108680712270230210000000253125817270131102502021B
0108680712270230210000000253125317270131102502021B
0108680712270230210000000253124117270131102502021B
0108680712270230210000000253124617270131102502021B
0108680712270230210000000253125717270131102502021B
0108680712270230210000000253124917270131102502021B
0108680712270230210000000253125017270131102502021B
0108680712270230210000000253125417270131102502021B
0108680712270230210000000253125217270131102502021B
0108680712270230210000000253126117270131102502021B
0108680712270230210000000253120817270131102502021B
0108680712270230210000000253120417270131102502021B
0108680712270230210000000253120317270131102502021B
0108680712270230210000000253120917270131102502021B
0108680712270230210000000253121117270131102502021B
0108680712270230210000000253120517270131102502021B
0108680712270230210000000253120617270131102502021B
0108680712270230210000000253121017270131102502021B
0108680712270230210000000253121217270131102502021B
0108680712270230210000000253120717270131102502021B
0108680712270230210000000253119717270131102502021B
0108680712270230210000000253120217270131102502021B
0108680712270230210000000253119617270131102502021B
0108680712270230210000000253120117270131102502021B
0108680712270230210000000253119517270131102502021B
0108680712270230210000000253119917270131102502021B
0108680712270230210000000253120017270131102502021B
0108680712270230210000000253119317270131102502021B
0108680712270230210000000253119817270131102502021B
0108680712270230210000000253118917270131102502021B
0108680712270230210000000253118817270131102502021B
0108680712270230210000000253119017270131102502021B
0108680712270230210000000253119117270131102502021B
0108680712270230210000000253119217270131102502021B
0108680712270230210000000253119417270131102502021B
0108680712270230210000000253117817270131102502021B
0108680712270230210000000253118317270131102502021B
0108680712270230210000000253117317270131102502021B
0108680712270230210000000253116917270131102502021B
0108680712270230210000000253116817270131102502021B
0108680712270230210000000253117417270131102502021B
0108680712270230210000000253116317270131102502021B
0108680712270230210000000253116417270131102502021B
0108680712270230210000000253117017270131102502021B
0108680712270230210000000253116517270131102502021B
0108680712270230210000000253117517270131102502021B
0108680712270230210000000253118017270131102502021B
0108680712270230210000000253117917270131102502021B
0108680712270230210000000253118517270131102502021B
0108680712270230210000000253118417270131102502021B
0108680712270230210000000253118217270131102502021B
0108680712270230210000000253118117270131102502021B
0108680712270230210000000253118717270131102502021B
0108680712270230210000000253118617270131102502021B
0108680712270230210000000253117717270131102502021B
0108680712270230210000000253117217270131102502021B
0108680712270230210000000253123117270131102502021B
0108680712270230210000000253117617270131102502021B
0108680712270230210000000253116717270131102502021B
0108680712270230210000000253116617270131102502021B
0108680712270230210000000253121317270131102502021B
0108680712270230210000000253121817270131102502021B
0108680712270230210000000253122317270131102502021B
0108680712270230210000000253122817270131102502021B
0108680712270230210000000253123317270131102502021B
0108680712270230210000000253121917270131102502021B
0108680712270230210000000253121417270131102502021B
0108680712270230210000000253122917270131102502021B
0108680712270230210000000253122417270131102502021B
0108680712270230210000000253123417270131102502021B
0108680712270230210000000253123017270131102502021B
0108680712270230210000000253123517270131102502021B
0108680712270230210000000253122017270131102502021B
0108680712270230210000000253122517270131102502021B
0108680712270230210000000253121517270131102502021B
0108680712270230210000000253121617270131102502021B
0108680712270230210000000253122117270131102502021B
0108680712270230210000000253122617270131102502021B
0108680712270230210000000253123217270131102502021B
0108680712270230210000000253123617270131102502021B
0108680712270230210000000253123717270131102502021B
0108680712270230210000000253117117270131102502021B
0108680712270230210000000253122717270131102502021B
0108680712270230210000000253122217270131102502021B
0108680712270230210000000253121717270131102502021B
0108699548014444211005202476501727083110A24212089
0108699548014444211005202476481727083110A24212089
0108699548014444211005202476471727083110A24212089
010869958775132421000000181651141726103110E058
010869958775132421000000181503841726103110E057
010869958775132421000000181503101726103110E057
010869958775132421000000181503231726103110E057
010869958775132421000000181503661726103110E057
010869958775132421000000181588621726103110E058
010869958775132421000000181503321726103110E057
010869958775132421000000181503871726103110E057
010869958775132421000000181503981726103110E057
010869958775132421000000181503771726103110E057
010869958775132421000000181503431726103110E057
010869958775132421000000181503561726103110E057
010869958775132421000000181651841726103110E058
010869955909034521R0000000581472172709301024015
010869955909034521R0000000581469172709301024015
010869955909034521R0000000581476172709301024015
010869955909034521R0000000581464172709301024015
010869955909034521R0000000581395172709301024015
010869955909034521R0000000581399172709301024015
010869955909034521R0000000581257172709301024015
010869955909034521R0000000581477172709301024015
010869955909034521R0000000581475172709301024015
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404"""
    
    # Satırlara böl ve temizle
    barcode_list = [b.strip() for b in barcodes.strip().split('\n') if b.strip()]
    
    print(f"\n{'='*60}")
    print(f"TOPLU STOK GİRİŞİ - ANA DEPO")
    print(f"{'='*60}")
    print(f"Toplam karekod sayısı: {len(barcode_list)}")
    print(f"{'='*60}\n")
    
    # Async olarak çalıştır
    results, gtin_counts = asyncio.run(bulk_add_stock(barcode_list))
    
    # Sonuçları göster
    print(f"\n{'='*60}")
    print("SONUÇ ÖZETİ")
    print(f"{'='*60}")
    print(f"✅ Başarılı: {len(results['success'])} adet")
    print(f"⏭️ Zaten mevcut: {len(results['already_exists'])} adet")
    print(f"❓ Bilinmeyen ilaç: {len(results['unknown_medication'])} adet")
    print(f"❌ Hata: {len(results['errors'])} adet")
    
    print(f"\n{'='*60}")
    print("İLAÇ BAZINDA ÖZET")
    print(f"{'='*60}")
    
    # Sırala ve göster
    sorted_gtins = sorted(gtin_counts.items(), key=lambda x: x[1]['count'], reverse=True)
    for gtin, info in sorted_gtins[:50]:  # İlk 50
        print(f"  {info['count']:3d} adet - {info['name'][:50]}")
    
    if len(sorted_gtins) > 50:
        print(f"  ... ve {len(sorted_gtins) - 50} ilaç daha")
    
    # Bilinmeyen ilaçları listele
    if results['unknown_medication']:
        print(f"\n{'='*60}")
        print("BİLİNMEYEN İLAÇLAR (GTIN)")
        print(f"{'='*60}")
        unique_gtins = set()
        for item in results['unknown_medication']:
            if item['gtin'] and item['gtin'] not in unique_gtins:
                unique_gtins.add(item['gtin'])
                print(f"  GTIN: {item['gtin']}")
    
    print(f"\n{'='*60}")
    print("İŞLEM TAMAMLANDI!")
    print(f"{'='*60}\n")
    
    return results, gtin_counts

if __name__ == "__main__":
    main()

