"""
Toplu Stok Girişi - Ana Depo
===========================
Tüm karekodları parse edip merkez depoya stok girişi yapar.
"""

import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
os.chdir(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

import asyncio
import json
import uuid
from datetime import datetime
from typing import Dict, List
from collections import defaultdict

# Tüm karekodlar
ALL_BARCODES = """0108699788750027212599607002003674172905311025607002
0108699788750027212599607002003670172905311025607002
0108699788750027212599607002003665172905311025607002
0108699788750027212599607002003682172905311025607002
0108699788750027212599607002003679172905311025607002
0108699788750027212599607002003666172905311025607002
0108699788750027212599607002003793172905311025607002
0108699788750027212599607002003673172905311025607002
0108699788750027212599607002003804172905311025607002
0108699788750027212599607002003668172905311025607002
0108699788750027212599607002003788172905311025607002
0108699788750027212599607002003676172905311025607002
010869960775008521100000029640051727013110220523003
010869960775008521100000029640251727013110220523003
010869960775008521100000029701491727013110220523003
010869960775008521100000029639241727013110220523003
010869968009005421I00241000974607317280331102400410003
010869968009005421I00241000974607417280331102400410003
010869968009005421I00241000974607817280331102400410003
010869968009005421I00241000974584817280331102400410003
010869968009005421I00241000974586117280331102400410003
010869968009005421I00241000974584317280331102400410003
010869968009005421I00241000974583717280331102400410003
010869968009005421I00241000974609117280331102400410003
010869968009005421I00241000974583617280331102400410003
010869968009005421I00241000974586017280331102400410003
010869968009005421I00241000974585417280331102400410003
010869968009005421I00241000974584917280331102400410003
010869968009005421I00241000974609017280331102400410003
010869968009005421I00241000974609617280331102400410003
010869885661023221C006378005633717270400104E068A
010869885661023221C006378035907917270400104E068A
010869885661023221C006378005640917270400104E068A
010869885661023221C006378005635517270400104E068A
010869885661023221C006378005640017270400104E068A
010869885661023221C006376073096217270400104E060A
010869885661023221C006378035907017270400104E068A
010868019971841621340000206293831725123110401000580
010869983275001021MEN97V4C7G50TM17290331102504015
010869983275001021MEN2GF052XM31417290331102504016
010869983275001021MENVH2H3VMWKH617281031102411073
01086995702400642158000010720792172705311025196079A
01086995702400642158000010721095172705311025196079A
01086995702400642158000010721086172705311025196079A
01086995702400642158000010720972172705311025196079A
01086995702400642158000010721051172705311025196079A
01086995702400642158000010721040172705311025196079A
01086995702400642158000009455435172703311025196043A
01086995702400642158000004721681172604301024196066A
01086995702400642158000010720784172705311025196079A
01086995702400642158000010720976172705311025196079A
01086995702400642158000010720828172705311025196079A
01086995702400642158000010720748172705311025196079A
01086995702400642158000010721104172705311025196079A
01086995702400642158000010720989172705311025196079A
01086995702400642158000010720695172705311025196079A
01086995702400642158000010720987172705311025196079A
01086995702400642158000010721001172705311025196079A
01086995702400642158000010720796172705311025196079A
01086995702400642158000010721065172705311025196079A
01086995702400642158000010721031172705311025196079A
01086995702400642158000010720958172705311025196079A
01086995702400642158000010721107172705311025196079A
01086995702400642158000010720965172705311025196079A
01086995702400642158000010720927172705311025196079A
01086995702400642158000010720984172705311025196079A
01086995702400642158000009455538172703311025196043A
01086995702400642158000010720967172705311025196079A
01086995702400642158000010721045172705311025196079A
01086995702400642158000010720810172705311025196079A
01086995702400642158000010721102172705311025196079A
01086995702400642158000010720993172705311025196079A
01086995702400642158000010720844172705311025196079A
01086995702400642158000010720855172705311025196079A
01086995702400642158000010720480172705311025196079A
01086995702400642158000010720893172705311025196079A
01086995702400642158000010720997172705311025196079A
01086995702400642158000010720918172705311025196079A
01086995702400642158000010720961172705311025196079A
01086995702400642158000010720980172705311025196079A
01086995702400642158000010720861172705311025196079A
01086995702400642158000010720934172705311025196079A
01086995702400642158000010720806172705311025196079A
01086995702400642158000010720941172705311025196079A
0108699546010028216262835042951727013110ELB01350
0108699546010028216149624783791727013110ELB01350
0108699546010028216304520480521727013110ELB01350
0108699546010028216583368651321727013110ELB01350
0108699546010028216865246237921727013110ELB01350
0108699546010028216104371173451727013110ELB01350
0108699546010028216332305914181727013110ELB01350
0108699546010028216779672845341727013110ELB01350
0108699546010028216377463692751727013110ELB01350
0108699546010028216943712427931727013110ELB01350
0108699546010028216165397239751727013110ELB01350
0108699546010028216039469160501727013110ELB01350
0108699546010028216482964823541727013110ELB01350
0108699546010028216080339664611727013110ELB01350
0108699546010028216643660166461727013110ELB01350
0108699546010028216223297234071727013110ELB01350
0108699546010028216871302970201727013110ELB01350
0108699546010028216926061734921727013110ELB01350
0108699546010028216158642953241727013110ELB01350
0108699546010028216213097713381727013110ELB01350
0108699546010028216570740679841727013110ELB01350
0108699546010028216402664675991726073110DLB04555
0108699546010028216671605027011727013110ELB01350
0108699546010028216634129666301727013110ELB01350
0108699546010028216584742171631727013110ELB01350
0108699546010028216917679386651727013110ELB01350
0108699546010028216037954290181727013110ELB01350
0108699546010028216946949851771727013110ELB01350
0108699546010028216779740921601727013110ELB01350
0108699546010028216874002820911727013110ELB01350
0108699546010028216836774762901727013110ELB01350
0108699546010028216567491723421727013110ELB01350
0108699546010028216782642732211727013110ELB01350
0108699546010028216665707980331726073110DLB04555
0108699546010028216176882870451727013110ELB01350
0108699546010028216563655277931727013110ELB01350
0108699546010028216043284413811727013110ELB01350
0108699546010028216242989759371727013110ELB01350
0108699546010028216198365069081727013110ELB01350
0108699546010028216930060532811727013110ELB01350
0108699546010028216626591710901727013110ELB01350
0108699546010028216672464176471727013110ELB01350
0108699546010028216533531799061727013110ELB01350
0108699546010028216745069060291727013110ELB01350
0108699546010028216681605528621727013110ELB01350
0108699546010028216073665124961727013110ELB01350
0108699546010028216828377119131727013110ELB01350
0108699546010028216258875685421727013110ELB01350
0108699546010028216785800075311727013110ELB01350
010869960775002321100000013302831726093010210513004
010869960775002321100000013177781726093010210513004
010869960775002321100000013303341726093010210513004
010869960775001621100000006323911727103110220514001
010869960775001621100000006323741727103110220514001
010869960775001621100000006323711727103110220514001
010869960775001621100000006323721727103110220514001
010869960775001621100000006323901727103110220514001
010869960775001621100000006324201727103110220514001
010869960775001621100000006323601727103110220514001
010869960775001621100000006323671727103110220514001
010869960775001621100000006324191727103110220514001
010869960775001621100000006323761727103110220514001
010869951638031121739000044076041726103110AA23472
010869951638031121739000044076011726103110AA23472
010869951638031121739000044076061726103110AA23472
010869951638031121739000044149811726103110AA23472
010869951638031121739000044076111726103110AA23472
010869951638031121739000044149861726103110AA23472
010869951638031121739000044076051726103110AA23472
010869951638031121739000044149761726103110AA23472
010869951638031121739000044076091726103110AA23472
010869951638031121739000044149841726103110AA23472
010869951638031121739000044076101726103110AA23472
010869951638031121739000044149831726103110AA23472
010869951638031121739000044076031726103110AA23472
010868142801190221A00000001475561726022810AA20024
010868142801190221A00000001475501726022810AA20024
010868142801190221A00000001466351726022810AA20024
010868142801190221A00000001475521726022810AA20024
010869951138020021ST0000002089521727103110A19642
010869951138020021ST0000002456791727103110A19642
0108680712270230210000000253126217270131102502021B
0108680712270230210000000253125517270131102502021B
0108680712270230210000000253126017270131102502021B
0108680712270230210000000253125917270131102502021B
0108680712270230210000000253124317270131102502021B
0108680712270230210000000253124817270131102502021B
0108680712270230210000000253124417270131102502021B
0108680712270230210000000253123817270131102502021B
0108680712270230210000000253124517270131102502021B
0108680712270230210000000253124017270131102502021B
0108680712270230210000000253125117270131102502021B
0108680712270230210000000253124217270131102502021B
0108680712270230210000000253124717270131102502021B
0108680712270230210000000253125617270131102502021B
0108680712270230210000000253123917270131102502021B
0108680712270230210000000253125817270131102502021B
0108680712270230210000000253125317270131102502021B
0108680712270230210000000253124117270131102502021B
0108680712270230210000000253124617270131102502021B
0108680712270230210000000253125717270131102502021B
0108680712270230210000000253124917270131102502021B
0108680712270230210000000253125017270131102502021B
0108680712270230210000000253125417270131102502021B
0108680712270230210000000253125217270131102502021B
0108680712270230210000000253126117270131102502021B
0108680712270230210000000253120817270131102502021B
0108680712270230210000000253120417270131102502021B
0108680712270230210000000253120317270131102502021B
0108680712270230210000000253120917270131102502021B
0108680712270230210000000253121117270131102502021B
0108680712270230210000000253120517270131102502021B
0108680712270230210000000253120617270131102502021B
0108680712270230210000000253121017270131102502021B
0108680712270230210000000253121217270131102502021B
0108680712270230210000000253120717270131102502021B
0108680712270230210000000253119717270131102502021B
0108680712270230210000000253120217270131102502021B
0108680712270230210000000253119617270131102502021B
0108680712270230210000000253120117270131102502021B
0108680712270230210000000253119517270131102502021B
0108680712270230210000000253119917270131102502021B
0108680712270230210000000253120017270131102502021B
0108680712270230210000000253119317270131102502021B
0108680712270230210000000253119817270131102502021B
0108680712270230210000000253118917270131102502021B
0108680712270230210000000253118817270131102502021B
0108680712270230210000000253119017270131102502021B
0108680712270230210000000253119117270131102502021B
0108680712270230210000000253119217270131102502021B
0108680712270230210000000253119417270131102502021B
0108680712270230210000000253117817270131102502021B
0108680712270230210000000253118317270131102502021B
0108680712270230210000000253117317270131102502021B
0108680712270230210000000253116917270131102502021B
0108680712270230210000000253116817270131102502021B
0108680712270230210000000253117417270131102502021B
0108680712270230210000000253116317270131102502021B
0108680712270230210000000253116417270131102502021B
0108680712270230210000000253117017270131102502021B
0108680712270230210000000253116517270131102502021B
0108680712270230210000000253117517270131102502021B
0108680712270230210000000253118017270131102502021B
0108680712270230210000000253117917270131102502021B
0108680712270230210000000253118517270131102502021B
0108680712270230210000000253118417270131102502021B
0108680712270230210000000253118217270131102502021B
0108680712270230210000000253118117270131102502021B
0108680712270230210000000253118717270131102502021B
0108680712270230210000000253118617270131102502021B
0108680712270230210000000253117717270131102502021B
0108680712270230210000000253117217270131102502021B
0108680712270230210000000253123117270131102502021B
0108680712270230210000000253117617270131102502021B
0108680712270230210000000253116717270131102502021B
0108680712270230210000000253116617270131102502021B
0108680712270230210000000253121317270131102502021B
0108680712270230210000000253121817270131102502021B
0108680712270230210000000253122317270131102502021B
0108680712270230210000000253122817270131102502021B
0108680712270230210000000253123317270131102502021B
0108680712270230210000000253121917270131102502021B
0108680712270230210000000253121417270131102502021B
0108680712270230210000000253122917270131102502021B
0108680712270230210000000253122417270131102502021B
0108680712270230210000000253123417270131102502021B
0108680712270230210000000253123017270131102502021B
0108680712270230210000000253123517270131102502021B
0108680712270230210000000253122017270131102502021B
0108680712270230210000000253122517270131102502021B
0108680712270230210000000253121517270131102502021B
0108680712270230210000000253121617270131102502021B
0108680712270230210000000253122117270131102502021B
0108680712270230210000000253122617270131102502021B
0108680712270230210000000253123217270131102502021B
0108680712270230210000000253123617270131102502021B
0108680712270230210000000253123717270131102502021B
0108680712270230210000000253117117270131102502021B
0108680712270230210000000253122717270131102502021B
0108680712270230210000000253122217270131102502021B
0108680712270230210000000253121717270131102502021B
0108699548014444211005202476501727083110A24212089
0108699548014444211005202476481727083110A24212089
0108699548014444211005202476471727083110A24212089
010869958775132421000000181651141726103110E058
010869958775132421000000181503841726103110E057
010869958775132421000000181503101726103110E057
010869958775132421000000181503231726103110E057
010869958775132421000000181503661726103110E057
010869958775132421000000181588621726103110E058
010869958775132421000000181503321726103110E057
010869958775132421000000181503871726103110E057
010869958775132421000000181503981726103110E057
010869958775132421000000181503771726103110E057
010869958775132421000000181503431726103110E057
010869958775132421000000181503561726103110E057
010869958775132421000000181651841726103110E058
010869955909034521R0000000581472172709301024015
010869955909034521R0000000581469172709301024015
010869955909034521R0000000581476172709301024015
010869955909034521R0000000581464172709301024015
010869955909034521R0000000581395172709301024015
010869955909034521R0000000581399172709301024015
010869955909034521R0000000581257172709301024015
010869955909034521R0000000581477172709301024015
010869955909034521R0000000581475172709301024015
0108699514093251215100000057050948172711301024U461
0108699514093251215100000057050944172711301024U461
0108699514093251215100000057050952172711301024U461
0108699514093251215100000057050940172711301024U461
0108699514093251215100000057050936172711301024U461
0108699514093251215100000057050937172711301024U461
0108699514093251215100000057050941172711301024U461
0108699514093251215100000057050953172711301024U461
0108699514093251215100000057050949172711301024U461
0108699514093251215100000057050942172711301024U461
0108699514093251215100000057050938172711301024U461
0108699514093251215100000057050946172711301024U461
0108699514093251215100000057050954172711301024U461
0108699514093251215100000057050950172711301024U461
0108699514093251215100000057050939172711301024U461
0108699514093251215100000057050951172711301024U461
0108699514093251215100000057050943172711301024U461
0108699514093251215100000057050955172711301024U461
0108699514093251215100000057050947172711301024U461
0108699514093251215100000057050945172711301024U461
0108699514093251215100000057050990172711301024U461
0108699514093251215100000057050979172711301024U461
0108699514093251215100000057050983172711301024U461
0108699514093251215100000057050987172711301024U461
0108699514093251215100000057050995172711301024U461
0108699514093251215100000057050991172711301024U461
0108699514093251215100000057050994172711301024U461
0108699514093251215100000057050982172711301024U461
0108699514093251215100000057050986172711301024U461
0108699514093251215100000057050978172711301024U461
0108699514093251215100000057050977172711301024U461
0108699514093251215100000057050981172711301024U461
0108699514093251215100000057050989172711301024U461
0108699514093251215100000057050993172711301024U461
0108699514093251215100000057050980172711301024U461
0108699514093251215100000057050984172711301024U461
0108699514093251215100000057050988172711301024U461
0108699514093251215100000057050992172711301024U461
0108699514093251215100000057050985172711301024U461
0108699514093251215100000057050976172711301024U461
0108699514093251215100000057050930172711301024U461
0108699514093251215100000057050934172711301024U461
0108699514093251215100000057050917172711301024U461
0108699514093251215100000057050927172711301024U461
0108699514093251215100000057050918172711301024U461
0108699514093251215100000057050923172711301024U461
0108699514093251215100000057050933172711301024U461
0108699514093251215100000057050929172711301024U461
0108699514093251215100000057050921172711301024U461
0108699514093251215100000057050922172711301024U461
0108699514093251215100000057050931172711301024U461
0108699514093251215100000057050928172711301024U461
0108699514093251215100000057050924172711301024U461
0108699514093251215100000057050916172711301024U461
0108699514093251215100000057050915172711301024U461
0108699514093251215100000057050920172711301024U461
0108699514093251215100000057050925172711301024U461
0108699514093251215100000057050926172711301024U461
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404
8699956000404"""

def load_medications_db():
    with open('data/medications_barcode.json', 'r', encoding='utf-8') as f:
        return json.load(f)

def parse_datamatrix(barcode: str) -> Dict:
    """GS1 DataMatrix karekodunu parse et"""
    result = {
        "gtin": None,
        "serial_number": None,
        "lot_number": None,
        "expiry_date": None,
        "expiry_date_str": None,
        "raw": barcode
    }
    
    if not barcode:
        return result
    
    barcode = barcode.strip()
    
    # Basit EAN-13 barkod mu kontrol et
    if len(barcode) == 13 and barcode.isdigit():
        result["gtin"] = barcode
        result["serial_number"] = f"EAN-{barcode}-{uuid.uuid4().hex[:8]}"
        return result
    
    # 01 ile başlıyorsa GS1 DataMatrix
    if barcode.startswith('01') and len(barcode) >= 16:
        result["gtin"] = barcode[2:16]
        rest = barcode[16:]
        
        # 21 Seri numarası
        if rest.startswith('21'):
            serial_end = len(rest)
            for ai in ['17', '10']:
                idx = rest.find(ai, 2)
                if idx > 2 and idx < serial_end:
                    serial_end = idx
            result["serial_number"] = rest[2:serial_end]
            rest = rest[serial_end:]
        
        # 17 Son kullanma tarihi  
        if '17' in rest:
            idx = rest.find('17')
            if idx >= 0 and len(rest) >= idx + 8:
                exp_str = rest[idx+2:idx+8]
                result["expiry_date_str"] = exp_str
                try:
                    year = 2000 + int(exp_str[0:2])
                    month = int(exp_str[2:4])
                    day = int(exp_str[4:6])
                    if day == 0:
                        day = 28
                    result["expiry_date"] = datetime(year, month, day)
                except:
                    pass
        
        # 10 Lot numarası
        if '10' in rest:
            idx = rest.find('10')
            if idx >= 0:
                lot_end = len(rest)
                for ai in ['17', '21']:
                    ai_idx = rest.find(ai, idx + 2)
                    if ai_idx > idx and ai_idx < lot_end:
                        lot_end = ai_idx
                result["lot_number"] = rest[idx+2:lot_end]
    
    if not result["serial_number"]:
        result["serial_number"] = f"RAW-{barcode[:20]}"
    
    return result

def get_medication_name(gtin: str, medications_db: dict) -> str:
    if not gtin:
        return None
    
    # Direkt eşleşme
    if gtin in medications_db:
        return medications_db[gtin]
    
    # 13 haneli versiyonu dene
    if len(gtin) == 14 and gtin.startswith('0'):
        ean13 = gtin[1:]
        if ean13 in medications_db:
            return medications_db[ean13]
    
    return None

async def bulk_add_stock(barcodes: List[str]):
    from motor.motor_asyncio import AsyncIOMotorClient
    
    mongo_url = 'mongodb+srv://healmedy_user:H3alm3dy2024!@abro.lwzasyg.mongodb.net/'
    db_name = 'healmedy_hbys'
    
    client = AsyncIOMotorClient(mongo_url)
    db = client[db_name]
    stock_collection = db.stock
    barcode_stock_collection = db.barcode_stock
    
    medications_db = load_medications_db()
    print(f"[INFO] {len(medications_db)} ilac veritabanindan yuklendi")
    
    results = {"success": 0, "exists": 0, "unknown": 0, "errors": 0}
    gtin_summary = defaultdict(lambda: {"name": "", "count": 0})
    
    for i, barcode in enumerate(barcodes):
        barcode = barcode.strip()
        if not barcode:
            continue
        
        try:
            parsed = parse_datamatrix(barcode)
            gtin = parsed.get("gtin")
            serial = parsed.get("serial_number")
            
            # Var mı kontrol et
            existing = await barcode_stock_collection.find_one({
                "serial_number": serial,
                "gtin": gtin
            })
            
            if existing:
                results["exists"] += 1
                continue
            
            # İlaç adını bul
            med_name = get_medication_name(gtin, medications_db)
            
            if not med_name:
                results["unknown"] += 1
                med_name = f"Bilinmeyen ({gtin[-6:] if gtin else 'N/A'})"
            
            # Summary güncelle
            gtin_summary[gtin]["name"] = med_name
            gtin_summary[gtin]["count"] += 1
            
            stock_id = str(uuid.uuid4())
            
            # Karekod stoğa ekle
            await barcode_stock_collection.insert_one({
                "_id": stock_id,
                "gtin": gtin or "",
                "serial_number": serial,
                "lot_number": parsed.get("lot_number"),
                "expiry_date": parsed.get("expiry_date"),
                "expiry_date_str": parsed.get("expiry_date_str"),
                "name": med_name,
                "location": "merkez_depo",
                "location_detail": "Ana Depo",
                "status": "available",
                "added_at": datetime.utcnow(),
                "added_by": "bulk_import",
                "added_by_name": "Toplu Ice Aktarma",
                "raw_barcode": barcode
            })
            
            # Ana stok collection'ına ekle
            await stock_collection.insert_one({
                "_id": str(uuid.uuid4()),
                "name": med_name,
                "code": gtin[:8] if gtin else serial[:8],
                "gtin": gtin,
                "quantity": 1,
                "min_quantity": 1,
                "location": "merkez_depo",
                "location_detail": "Ana Depo",
                "lot_number": parsed.get("lot_number"),
                "serial_number": serial,
                "expiry_date": parsed.get("expiry_date"),
                "qr_code": stock_id,
                "unit": "adet",
                "created_at": datetime.utcnow(),
                "updated_at": datetime.utcnow(),
                "barcode_stock_id": stock_id
            })
            
            results["success"] += 1
            
            if (i + 1) % 100 == 0:
                print(f"  İşlendi: {i + 1}/{len(barcodes)}")
            
        except Exception as e:
            results["errors"] += 1
            print(f"  HATA: {barcode[:30]}... -> {str(e)[:50]}")
    
    client.close()
    return results, dict(gtin_summary)

def main():
    barcode_list = [b.strip() for b in ALL_BARCODES.strip().split('\n') if b.strip()]
    
    print("\n" + "="*60)
    print("TOPLU STOK GIRISI - ANA DEPO")
    print("="*60)
    print(f"Toplam karekod: {len(barcode_list)}")
    print("="*60 + "\n")
    
    results, gtin_summary = asyncio.run(bulk_add_stock(barcode_list))
    
    print("\n" + "="*60)
    print("SONUC OZETI")
    print("="*60)
    print(f"  Basarili: {results['success']} adet")
    print(f"  Zaten mevcut: {results['exists']} adet")
    print(f"  Bilinmeyen ilac: {results['unknown']} adet")
    print(f"  Hata: {results['errors']} adet")
    
    print("\n" + "="*60)
    print("ILAC BAZINDA OZET")
    print("="*60)
    
    sorted_items = sorted(gtin_summary.items(), key=lambda x: x[1]['count'], reverse=True)
    for gtin, info in sorted_items:
        print(f"  {info['count']:3d} adet - {info['name'][:55]}")
    
    print("\n" + "="*60)
    print("ISLEM TAMAMLANDI!")
    print("="*60 + "\n")

if __name__ == "__main__":
    main()













