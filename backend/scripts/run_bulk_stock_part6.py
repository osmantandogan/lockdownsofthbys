"""
Toplu Stok GiriÅŸi - Part 6
"""
import sys, os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
os.chdir(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

import asyncio, json, uuid
from datetime import datetime
from collections import defaultdict

ALL = """0108699844770143211500000153004217271130102229018
0108699844770143211500000152892817271130102229018
0108699844770143211500000153003717271130102229018
0108699844770143211500000153004317271130102229018
0108699844770143211500000153003617271130102229018
0108699844770143211500000153003317271130102229018
0108699844770143211500000130152417271031102229014
0108699844770143211500000153003217271130102229018
0108699844770143211500000152505517271130102229018
0108699844770143211500000153003417271130102229018
0108699844770143211500000153003817271130102229018
0108699844770143211500000153003917271130102229018
0108699844770143211500000153002517271130102229018
0108699844770143211500000078052617270131102229004
0108699844770143211500000152974317271130102229018
0108699844770143211500000152929017271130102229018
0108699844770143211500000152965517271130102229018
0108699844770143211500000130152517271031102229014
0108699844770143211500000130152117271031102229014
0108699844700874210300000987174817261231105282006
0108699844700874210300000987174417261231105282006
010869954027002221100010795450391728063010ERCZ011A
010869954027002221100010795409071728063010ERCZ011A
010869954027002221100010796031291728063010ERCZ011A
010869954027002221100010794483581728063010ERCZ011A
010869954027002221100010794121371728063010ERCZ011A
010869954027002221100010794593321728063010ERCZ011A
010869954027002221100010794178801728063010ERCZ011A
010869954027002221100010795625171728063010ERCZ011A
010869954027002221100010794162731728063010ERCZ011A
010869954027002221100010794970811728063010ERCZ011A
010869954027002221100010795212631728063010ERCZ011A
010869954027002221100010794448501728063010ERCZ011A
010869954027002221100010795970001728063010ERCZ011A
010869954027002221100010796329851728063010ERCZ011A
010869954027002221100010794319771728063010ERCZ011A
010869954027002221100010796011451728063010ERCZ011A
010869954027002221100010795831141728063010ERCZ011A
010869954027002221100010794495001728063010ERCZ011A
010869954027002221100010796349021728063010ERCZ011A
010869954027002221100010794868361728063010ERCZ011A
010869954027002221100010796050301728063010ERCZ011A
010869954027002221100010796264781728063010ERCZ011A
010869954027002221100010795887791728063010ERCZ011A
010869954027002221100010795322091728063010ERCZ011A
010869954027002221100010794482431728063010ERCZ011A
010869954027002221100010794713861728063010ERCZ011A
010869954027002221100010796233471728063010ERCZ011A
010869954027002221100010794053231728063010ERCZ011A
010869954027002221100010794600181728063010ERCZ011A
010869954027002221100010795102221728063010ERCZ011A
010869954027002221100010796044781728063010ERCZ011A
010869954027002221100010795572901728063010ERCZ011A
010869954027002221100010796017801728063010ERCZ011A
010869954027002221100010794400101728063010ERCZ011A
010869954027002221100010794160461728063010ERCZ011A
010869954027002221100010796357721728063010ERCZ011A
010869954027002221100010796000341728063010ERCZ011A
010869954027002221100010794511301728063010ERCZ011A
010869954027002221100010794101431728063010ERCZ011A
010869954027002221100010795673991728063010ERCZ011A
010869954027002221100010795535951728063010ERCZ011A
010869954027002221100010795057481728063010ERCZ011A
010869954027002221100010795108011728063010ERCZ011A
010869954027002221100010795083211728063010ERCZ011A
010869954027002221100010796170241728063010ERCZ011A
010869954027002221100010795437931728063010ERCZ011A
010869954027002221100010796320861728063010ERCZ011A
010869954027002221100010794210681728063010ERCZ011A
010869954027002221100010794287021728063010ERCZ011A
010869954027002221100010795119141728063010ERCZ011A
010869954027002221100010794094961728063010ERCZ011A
010869954027002221100010795955111728063010ERCZ011A
010869954027002221100010795813441728063010ERCZ011A
010869954027002221100010796273811728063010ERCZ011A
010869954027002221100010795644451728063010ERCZ011A
010869954027002221100010795509621728063010ERCZ011A
010869954027002221100010795069691728063010ERCZ011A
010869954027002221100010794646041728063010ERCZ011A
010869954027002221100010794948091728063010ERCZ011A
010869954027002221100010795964431728063010ERCZ011A
010869954027002221100010795401291728063010ERCZ011A
010869954027002221100010795095251728063010ERCZ011A
010869954027002221100010795433401728063010ERCZ011A
010869954027002221100010794567661728063010ERCZ011A
010869954027002221100010794442861728063010ERCZ011A
010869954027002221100010795887341728063010ERCZ011A
010869954027002221100010794767091728063010ERCZ011A
010869954027002221100010795885991728063010ERCZ011A
010869954027002221100010794994411728063010ERCZ011A
010869954027002221100010794765731728063010ERCZ011A
010869954027002221100010794208981728063010ERCZ011A
010869954027002221100010795557971728063010ERCZ011A
010869954027002221100010795144781728063010ERCZ011A
010869954027002221100010795561161728063010ERCZ011A
010869954027002221100010794913451728063010ERCZ011A
010869954027002221100010795280841728063010ERCZ011A
010869954027002221100010795508171728063010ERCZ011A
010869954027002221100010795834051728063010ERCZ011A
010869954027002221100010795421091728063010ERCZ011A
010869954027002221100010795480911728063010ERCZ011A
010869954027002221100010794448781728063010ERCZ011A
010869954027002221100010796363871728063010ERCZ011A
010869954027002221100010794756601728063010ERCZ011A
010869954027002221100010794799431728063010ERCZ011A
010869954027002221100010795313851728063010ERCZ011A
010869954027002221100010795431071728063010ERCZ011A
010869954027002221100010795755041728063010ERCZ011A
010869954027002221100010795851711728063010ERCZ011A
010869954027002221100010796222181728063010ERCZ011A
010869954027002221100010795728051728063010ERCZ011A
010869954027002221100010795240261728063010ERCZ011A
010869954027002221100010796260451728063010ERCZ011A
010869954027002221100010794624071728063010ERCZ011A
010869954027002221100010795019731728063010ERCZ011A
010869954027002221100010795108381728063010ERCZ011A
010869954027002221100010794490771728063010ERCZ011A
010869954027002221100010795928791728063010ERCZ011A
010869954027002221100010795213931728063010ERCZ011A
010869954027002221100010796332551728063010ERCZ011A
010869954027002221100010795196851728063010ERCZ011A
010869954027002221100010794198771728063010ERCZ011A
010869954027002221100010796065191728063010ERCZ011A
010869954027002221100010795442311728063010ERCZ011A
010869954027002221100010795646091728063010ERCZ011A
010869954027002221100010795209581728063010ERCZ011A
010869954027002221100010794250041728063010ERCZ011A
010869954027002221100010794062201728063010ERCZ011A
010869954027002221100010795520171728063010ERCZ011A
010869954027002221100010794827951728063010ERCZ011A
010869954027002221100010796282451728063010ERCZ011A
010869954027002221100010794153891728063010ERCZ011A
010869954027002221100010794658351728063010ERCZ011A
010869954027002221100010795986131728063010ERCZ011A
010869954027002221100010796333801728063010ERCZ011A
010869954027002221100010794875611728063010ERCZ011A
010869954027002221100010794262061728063010ERCZ011A
010869954027002221100010796136781728063010ERCZ011A
010869954027002221100010794622641728063010ERCZ011A
010869954027002221100010796139561728063010ERCZ011A
010869954027002221100010794927441728063010ERCZ011A
010869954027002221100010795606451728063010ERCZ011A
010869954027002221100010795483301728063010ERCZ011A
010869954027002221100010794492071728063010ERCZ011A
010869954027002221100010796339041728063010ERCZ011A
010869954027002221100010794752021728063010ERCZ011A
010869954027002221100010796076441728063010ERCZ011A
010869954027002221100010794176081728063010ERCZ011A
010869954027002221100010794399391728063010ERCZ011A
010869954027002221100010794521811728063010ERCZ011A
010869954027002221100010796370601728063010ERCZ011A
010869954027002221100010794847771728063010ERCZ011A
010869954027002221100010796023321728063010ERCZ011A
010869954027002221100010795260911728063010ERCZ011A
010869954027002221100010794258401728063010ERCZ011A
010869954027002221100010794244011728063010ERCZ011A
010869954027002221100010794922871728063010ERCZ011A
010869954027002221100010796143441728063010ERCZ011A
010869954027002221100010794235781728063010ERCZ011A
010869954027002221100010795192731728063010ERCZ011A
010869954027002221100010794476731728063010ERCZ011A
010869954027002221100010795662511728063010ERCZ011A
010869954027002221100010794887671728063010ERCZ011A
010869954027002221100010796328221728063010ERCZ011A
010869954027002221100010796425571728063010ERCZ011A
010869954027002221100010794811411728063010ERCZ011A
010869954027002221100010796296051728063010ERCZ011A
010869954027002221100010796406361728063010ERCZ011A
010869954027002221100010795775041728063010ERCZ011A
010869954027002221100010794511141728063010ERCZ011A
010869954027002221100010795637391728063010ERCZ011A
010869954027002221100010796324021728063010ERCZ011A
010869954027002221100010796048931728063010ERCZ011A
010869954027002221100010794845381728063010ERCZ011A
010869954027002221100010795469141728063010ERCZ011A
010869954027002221100010796264821728063010ERCZ011A
010869954027002221100010795921941728063010ERCZ011A
010869954027002221100010795577891728063010ERCZ011A
010869954027002221100010796129841728063010ERCZ011A
010869954027002221100010794117211728063010ERCZ011A
010869954027002221100010795876061728063010ERCZ011A
010869954027002221100010795657151728063010ERCZ011A
010869954027002221100010794427491728063010ERCZ011A
010869954027002221100010794346851728063010ERCZ011A
0108698747380015212017910117055717261231100009
0108698747380015212017910117067717261231100009
0108698747380015212017910117067817261231100009
0108698747380015212017910117031817261231100009
0108698747380015212017910117069817261231100009
0108698747380015212017910117068617261231100009
0108698747380015212017910117069317261231100009
0108698747380015212017910117036517261231100009
0108698747380015212017910117066317261231100009
0108698747380015212017910117067917261231100009
0108698747380015212017910117068817261231100009
0108698747380015212017910117036617261231100009
0108698747380015212017910117066717261231100009
0108698747380015212017910117068217261231100009
0108698747380015212017910117054117261231100009
0108698747380015212017910117068317261231100009
0108698747380015212017910117068917261231100009
0108698747380015212017910117069617261231100009
0108698747380015212017910117056017261231100009"""

def load_meds():
    with open('data/medications_barcode.json', 'r', encoding='utf-8') as f:
        return json.load(f)

def parse(bc):
    r = {"gtin": None, "serial_number": None, "lot_number": None, "expiry_date": None, "raw": bc}
    if not bc: return r
    bc = bc.strip()
    if len(bc) == 13 and bc.isdigit():
        r["gtin"] = bc; r["serial_number"] = f"EAN-{bc}-{uuid.uuid4().hex[:8]}"; return r
    if bc.startswith('01') and len(bc) >= 16:
        r["gtin"] = bc[2:16]; rest = bc[16:]
        if rest.startswith('21'):
            se = len(rest)
            for ai in ['17', '10']:
                idx = rest.find(ai, 2)
                if idx > 2 and idx < se: se = idx
            r["serial_number"] = rest[2:se]; rest = rest[se:]
        if '17' in rest:
            idx = rest.find('17')
            if idx >= 0 and len(rest) >= idx + 8:
                try:
                    e = rest[idx+2:idx+8]
                    r["expiry_date"] = datetime(2000+int(e[0:2]), int(e[2:4]), max(1, int(e[4:6])))
                except: pass
        if '10' in rest:
            idx = rest.find('10')
            if idx >= 0:
                le = len(rest)
                for ai in ['17', '21']:
                    ai_idx = rest.find(ai, idx+2)
                    if ai_idx > idx and ai_idx < le: le = ai_idx
                r["lot_number"] = rest[idx+2:le]
    if not r["serial_number"]: r["serial_number"] = f"RAW-{bc[:20]}"
    return r

def get_name(gtin, db):
    if not gtin: return None
    if gtin in db: return db[gtin]
    if len(gtin) == 14 and gtin.startswith('0') and gtin[1:] in db: return db[gtin[1:]]
    return None

async def main():
    from motor.motor_asyncio import AsyncIOMotorClient
    bcs = [b.strip() for b in ALL.strip().split('\n') if b.strip()]
    client = AsyncIOMotorClient('mongodb+srv://healmedy_user:H3alm3dy2024!@abro.lwzasyg.mongodb.net/')
    db = client['healmedy_hbys']
    meds = load_meds()
    print(f"PART 6: {len(bcs)} karekod")
    res = {"success": 0, "exists": 0}
    sm = defaultdict(lambda: {"name": "", "count": 0})
    for bc in bcs:
        if not bc: continue
        try:
            p = parse(bc)
            g, s = p.get("gtin"), p.get("serial_number")
            if await db.barcode_stock.find_one({"serial_number": s, "gtin": g}):
                res["exists"] += 1; continue
            n = get_name(g, meds) or f"Bilinmeyen ({g[-6:] if g else 'N/A'})"
            sm[g]["name"] = n; sm[g]["count"] += 1
            sid = str(uuid.uuid4())
            await db.barcode_stock.insert_one({
                "_id": sid, "gtin": g or "", "serial_number": s,
                "lot_number": p.get("lot_number"), "expiry_date": p.get("expiry_date"),
                "name": n, "location": "merkez_depo", "location_detail": "Ana Depo",
                "status": "available", "added_at": datetime.utcnow(), "added_by": "bulk_import",
                "added_by_name": "Toplu Ice Aktarma", "raw_barcode": bc
            })
            await db.stock.insert_one({
                "_id": str(uuid.uuid4()), "name": n, "code": g[:8] if g else s[:8],
                "gtin": g, "quantity": 1, "min_quantity": 1, "location": "merkez_depo",
                "location_detail": "Ana Depo", "lot_number": p.get("lot_number"),
                "serial_number": s, "expiry_date": p.get("expiry_date"),
                "qr_code": sid, "unit": "adet", "created_at": datetime.utcnow(),
                "updated_at": datetime.utcnow(), "barcode_stock_id": sid
            })
            res["success"] += 1
        except: pass
    client.close()
    print(f"SONUC: {res['success']} eklendi, {res['exists']} mevcut")
    for g, i in sorted(sm.items(), key=lambda x: x[1]['count'], reverse=True)[:15]:
        print(f"  {i['count']:3d}x {i['name'][:55]}")
    print("TAMAMLANDI!")

if __name__ == "__main__":
    asyncio.run(main())













