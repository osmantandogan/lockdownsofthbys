"""
Toplu Stok GiriÅŸi - Part 3
"""

import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
os.chdir(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

import asyncio
import json
import uuid
from datetime import datetime
from typing import Dict, List
from collections import defaultdict

ALL_BARCODES = """010868180109028921252748000022861727053110252748
010868180109028921252754000021181727083110252754
010868180109028921252735000018881727053110252735
010868180109028921252735000018851727053110252735
010868180109028921252748000022121727053110252748
010868180109028921252748000022171727053110252748
010868180109028921252748000022891727053110252748
010868180109028921252748000022101727053110252748
010868180109028921252754000021191727083110252754
010868180109028921252748000022231727053110252748
010868180109028921252748000022841727053110252748
010868180109028921252748000022961727053110252748
010868180109028921252748000022911727053110252748
010868180109028921252748000022291727053110252748
010869971709006421220576531728010810250155
010869971709006421220576521728010810250155
010869971709006421220576571728010810250155
010869971709006421220576411728010810250155
010869971709006421220576441728010810250155
010869971709006421220576691728010810250155
010869971709006421220576671728010810250155
010869971709006421220576431728010810250155
010869971709006421220576621728010810250155
010869971709006421220576541728010810250155
010869971709006421220576391728010810250155
010869971709006421220576511728010810250155
01086995691500152119000003336878172707311024019013A
01086995691500152119000003336908172707311024019013A
01086995691500152119000003336860172707311024019013A
01086995691500152119000003336899172707311024019013A
01086995691500152119000003336881172707311024019013A
01086995691500152119000003336845172707311024019013A
01086995691500152119000003336830172707311024019013A
01086995691500152119000003336832172707311024019013A
01086995691500152119000003336848172707311024019013A
01086995691500152119000003336865172707311024019013A
01086995691500152119000003336885172707311024019013A
01086995691500152119000003336902172707311024019013A
01086995691500152119000003336889172707311024019013A
01086995691500152119000003336904172707311024019013A
01086995691500152119000003336850172707311024019013A
01086995691500152119000003336870172707311024019013A
01086995691500152119000003336835172707311024019013A
01086995691500152119000003336854172707311024019013A
01086995691500152119000003336838172707311024019013A
01086995691500152119000003336873172707311024019013A
01086995691500152119000003336892172707311024019013A
01086995691500152119000003336906172707311024019013A
01086995691500152119000003336896172707311024019013A
01086995691500152119000003336858172707311024019013A
01086995691500152119000003336841172707311024019013A
01086995691500152119000003336937172707311024019013A
01086995691500152119000003336933172707311024019013A
01086995691500152119000003336913172707311024019013A
01086995691500152119000003336916172707311024019013A
01086995691500152119000003336953172707311024019013A
01086995691500152119000003336957172707311024019013A
01086995691500152119000003336976172707311024019013A
01086995691500152119000003336972172707311024019013A
01086995691500152119000003336992172707311024019013A
01086995691500152119000003336990172707311024019013A
01086995691500152119000003336979172707311024019013A
01086995691500152119000003336961172707311024019013A
01086995691500152119000003336942172707311024019013A
01086995691500152119000003336920172707311024019013A
01086997887505842124643015038168172603301024643015
01086997887505842124643015038170172603301024643015
01086997887505842124643015038166172603301024643015
01086997887505842124643015038165172603301024643015
01086997887505842124643015038169172603301024643015
01086997887505842124643015038162172603301024643015
01086997887505842124643015038160172603301024643015
01086997887505842124643015038163172603301024643015
01086997887505842124643015038164172603301024643015
01086997887505842124643015038161172603301024643015
01086997887505842124643015038167172603301024643015
01086997887505842124643015038171172603301024643015
01086997887505842124643015038159172603301024643015
01086997887505842124643015038151172603301024643015
01086997887505842124643015038148172603301024643015
01086997887505842124643015038147172603301024643015
01086997887505842124643015038152172603301024643015
01086997887505842124643015038150172603301024643015
01086997887505842124643015038153172603301024643015
01086997887505842124643015038154172603301024643015
01086997887505842124643015038155172603301024643015
01086997887505842124643015038156172603301024643015
01086997887505842124643015038157172603301024643015
01086997887505842124643015038158172603301024643015
01086997887505842124643015038128172603301024643015
01086995697502392173000002480330172602281024440002C
01086995697502392173000002480319172602281024440002C
01086995697502392173000002480697172602281024440002C
01086995697502392173000002480312172602281024440002C
01086995697502392173000002480194172602281024440002C
01086995697502392173000002480164172602281024440002C
01086995697502392173000002480568172602281024440002C
01086995697502392173000002480565172602281024440002C
01086995697502392173000002480570172602281024440002C
01086995697502392173000002480318172602281024440002C
01086995697502392173000002480695172602281024440002C
01086995697502392173000002482407172602281024440002C
01086995697502392173000002480569172602281024440002C
01086995697502392173000002482424172602281024440002C
01086995697502392173000002480573172602281024440002C
01086995697502392173000002480185172602281024440002C
01086995697502392173000002482395172602281024440002C
01086995697502392173000002480322172602281024440002C
01086995697502392173000002480705172602281024440002C
01086995697502392173000002482396172602281024440002C
01086995697502392173000002480696172602281024440002C
01086995697502392173000002480177172602281024440002C
01086995697502392173000002482477172602281024440002C
01086995697502392173000002480564172602281024440002C
01086996067646872100009791491726063010D26190005A
010869962238010621245944000029401727073110245944
010869962238010621245944000028481727073110245944
010869962238010621245932000050161727063010245932
010869962238010621245944000029501727073110245944
010869962238010621245944000028591727073110245944
010869962238010621245932000050651727063010245932
010869962238010621245944000029041727073110245944
010869962238010621245932000050931727063010245932
010869962238010621245944000029561727073110245944
010869962238010621245932000051031727063010245932
010869962238010621ST0000000777941726033110235918
010869962238010621245944000029111727073110245944
010869962238010621245932000051791727063010245932
010869962238010621245944000028681727073110245944
010869962238010621245944000030131727073110245944
010869962238010621245944000028701727073110245944
010869962238010621245944000028491727073110245944
010869962238010621245932000050521727063010245932
010869962238010621245944000029551727073110245944
010869962238010621245932000051661727063010245932
010869962238010621245932000050341727063010245932
010869962238010621245944000029581727073110245944
010869962238010621245944000029101727073110245944
010869962238010621245932000050511727063010245932
010869962238010621245932000051811727063010245932
010869962238010621245932000050971727063010245932
010869962238010621245932000050731727063010245932
010869962238010621245932000050491727063010245932
010869962238010621245932000050291727063010245932
010869962238010621245932000050301727063010245932
010869962238010621245932000050391727063010245932
010869962238010621245932000050981727063010245932
010869962238010621245944000030011727073110245944
010869962238010621245932000051681727063010245932
010869962238010621245932000050851727063010245932
010869962238010621245925000107821727063010245925
010869962238010621245944000030051727073110245944
010869962238010621245944000028641727073110245944
010869962238010621245944000028631727073110245944
010869962238010621ST0000000779011726033110235918
010869962238010621245944000030001727073110245944
010869962238010621245944000028391727073110245944
010869962238010621245944000028601727073110245944
010869962238010621245944000028381727073110245944
010869962238010621245944000028431727073110245944
010869962238010621245944000029081727073110245944
010869962238010621245944000028691727073110245944
010869962238010621245944000028651727073110245944
010869962238010621245944000028401727073110245944
010869962238010621245944000028421727073110245944
010869962238010621245932000050721727063010245932
010869962238010621245944000030021727073110245944
010869962238010621245944000029841727073110245944
010869962238010621245944000029831727073110245944
010869962238010621245944000029821727073110245944
010869962238010621245944000029811727073110245944
010869962238010621245944000028811727073110245944
010869962238010621245944000028671727073110245944
010869962238010621245944000028831727073110245944
010869962238010621245944000028821727073110245944
010869962238010621245944000028851727073110245944"""

def load_medications_db():
    with open('data/medications_barcode.json', 'r', encoding='utf-8') as f:
        return json.load(f)

def parse_datamatrix(barcode: str) -> Dict:
    result = {"gtin": None, "serial_number": None, "lot_number": None, "expiry_date": None, "expiry_date_str": None, "raw": barcode}
    if not barcode:
        return result
    barcode = barcode.strip()
    if len(barcode) == 13 and barcode.isdigit():
        result["gtin"] = barcode
        result["serial_number"] = f"EAN-{barcode}-{uuid.uuid4().hex[:8]}"
        return result
    if barcode.startswith('01') and len(barcode) >= 16:
        result["gtin"] = barcode[2:16]
        rest = barcode[16:]
        if rest.startswith('21'):
            serial_end = len(rest)
            for ai in ['17', '10']:
                idx = rest.find(ai, 2)
                if idx > 2 and idx < serial_end:
                    serial_end = idx
            result["serial_number"] = rest[2:serial_end]
            rest = rest[serial_end:]
        if '17' in rest:
            idx = rest.find('17')
            if idx >= 0 and len(rest) >= idx + 8:
                exp_str = rest[idx+2:idx+8]
                result["expiry_date_str"] = exp_str
                try:
                    year = 2000 + int(exp_str[0:2])
                    month = int(exp_str[2:4])
                    day = int(exp_str[4:6])
                    if day == 0: day = 28
                    result["expiry_date"] = datetime(year, month, day)
                except: pass
        if '10' in rest:
            idx = rest.find('10')
            if idx >= 0:
                lot_end = len(rest)
                for ai in ['17', '21']:
                    ai_idx = rest.find(ai, idx + 2)
                    if ai_idx > idx and ai_idx < lot_end:
                        lot_end = ai_idx
                result["lot_number"] = rest[idx+2:lot_end]
    if not result["serial_number"]:
        result["serial_number"] = f"RAW-{barcode[:20]}"
    return result

def get_medication_name(gtin: str, medications_db: dict) -> str:
    if not gtin: return None
    if gtin in medications_db: return medications_db[gtin]
    if len(gtin) == 14 and gtin.startswith('0'):
        ean13 = gtin[1:]
        if ean13 in medications_db: return medications_db[ean13]
    return None

async def bulk_add_stock(barcodes: List[str]):
    from motor.motor_asyncio import AsyncIOMotorClient
    client = AsyncIOMotorClient('mongodb+srv://healmedy_user:H3alm3dy2024!@abro.lwzasyg.mongodb.net/')
    db = client['healmedy_hbys']
    stock_collection = db.stock
    barcode_stock_collection = db.barcode_stock
    medications_db = load_medications_db()
    print(f"[INFO] {len(medications_db)} ilac yuklendi")
    results = {"success": 0, "exists": 0, "unknown": 0, "errors": 0}
    gtin_summary = defaultdict(lambda: {"name": "", "count": 0})
    for i, barcode in enumerate(barcodes):
        barcode = barcode.strip()
        if not barcode: continue
        try:
            parsed = parse_datamatrix(barcode)
            gtin = parsed.get("gtin")
            serial = parsed.get("serial_number")
            existing = await barcode_stock_collection.find_one({"serial_number": serial, "gtin": gtin})
            if existing:
                results["exists"] += 1
                continue
            med_name = get_medication_name(gtin, medications_db)
            if not med_name:
                results["unknown"] += 1
                med_name = f"Bilinmeyen ({gtin[-6:] if gtin else 'N/A'})"
            gtin_summary[gtin]["name"] = med_name
            gtin_summary[gtin]["count"] += 1
            stock_id = str(uuid.uuid4())
            await barcode_stock_collection.insert_one({
                "_id": stock_id, "gtin": gtin or "", "serial_number": serial,
                "lot_number": parsed.get("lot_number"), "expiry_date": parsed.get("expiry_date"),
                "name": med_name, "location": "merkez_depo", "location_detail": "Ana Depo",
                "status": "available", "added_at": datetime.utcnow(), "added_by": "bulk_import",
                "added_by_name": "Toplu Ice Aktarma", "raw_barcode": barcode
            })
            await stock_collection.insert_one({
                "_id": str(uuid.uuid4()), "name": med_name, "code": gtin[:8] if gtin else serial[:8],
                "gtin": gtin, "quantity": 1, "min_quantity": 1, "location": "merkez_depo",
                "location_detail": "Ana Depo", "lot_number": parsed.get("lot_number"),
                "serial_number": serial, "expiry_date": parsed.get("expiry_date"),
                "qr_code": stock_id, "unit": "adet", "created_at": datetime.utcnow(),
                "updated_at": datetime.utcnow(), "barcode_stock_id": stock_id
            })
            results["success"] += 1
            if (i + 1) % 100 == 0: print(f"  Islendi: {i + 1}/{len(barcodes)}")
        except Exception as e:
            results["errors"] += 1
    client.close()
    return results, dict(gtin_summary)

def main():
    barcode_list = [b.strip() for b in ALL_BARCODES.strip().split('\n') if b.strip()]
    print(f"\nPART 3 - {len(barcode_list)} karekod\n")
    results, gtin_summary = asyncio.run(bulk_add_stock(barcode_list))
    print(f"\nSONUC: Basarili={results['success']}, Mevcut={results['exists']}, Bilinmeyen={results['unknown']}, Hata={results['errors']}")
    for gtin, info in sorted(gtin_summary.items(), key=lambda x: x[1]['count'], reverse=True)[:25]:
        print(f"  {info['count']:3d}x {info['name'][:55]}")
    print("\nTAMAMLANDI!\n")

if __name__ == "__main__":
    main()













