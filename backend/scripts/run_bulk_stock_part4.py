"""
Toplu Stok Girişi - Part 4 (Kalan tüm karekodlar)
"""

import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
os.chdir(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

import asyncio
import json
import uuid
from datetime import datetime
from typing import Dict, List
from collections import defaultdict

ALL_BARCODES = """010869962238010621245944000029071727073110245944
010869962238010621245944000029061727073110245944
010869962238010621245944000028901727073110245944
010869962238010621245944000028921727073110245944
010869962238010621245944000028911727073110245944
010869962238010621245944000029371727073110245944
010869962238010621245944000029591727073110245944
010869962238010621245944000030091727073110245944
010869962238010621245944000030111727073110245944
010869962238010621245944000030121727073110245944
010869962238010621245944000029251727073110245944
010869962238010621245944000029651727073110245944
010869962238010621245944000029511727073110245944
010869962238010621245944000029261727073110245944
010869962238010621245944000029351727073110245944
010869962238010621245944000029341727073110245944
010869962238010621245944000029331727073110245944
010869962238010621245944000029521727073110245944
010869962238010621245944000029531727073110245944
010869962238010621245944000029541727073110245944
010869962238010621245944000028621727073110245944
010869962238010621245944000029151727073110245944
010869962238010621245944000029091727073110245944
010869962238010621245932000050401727063010245932
010869962238010621245932000051171727063010245932
010869962238010621245932000051071727063010245932
010869962238010621245944000029661727073110245944
010869962238010621245944000030071727073110245944
010869962238010621245932000051851727063010245932
010869962238010621245944000030031727073110245944
010869962238010621245944000029791727073110245944
010869962238010621245944000029781727073110245944
010869962238010621245944000029601727073110245944
010869962238010621245944000029471727073110245944
010869962238010621245944000029481727073110245944
010869962238010621245932000051391727063010245932
010869962238010621245944000029921727073110245944
010869962238010621245932000050261727063010245932
010869962238010621245944000029191727073110245944
010869962238010621245944000029161727073110245944
010869962238010621245944000029181727073110245944
010869962238010621245944000029171727073110245944
010869962238010621245944000029141727073110245944
010869962238010621245944000028661727073110245944
010869962238010621245944000028871727073110245944
010869962238010621245944000028891727073110245944
010869962238010621245944000028861727073110245944
010869962238010621245944000028841727073110245944
010869962238010621245944000029631727073110245944
010869962238010621245944000029641727073110245944
010869962238010621245944000029621727073110245944
010869962238010621245944000029611727073110245944
010869962238010621245944000029771727073110245944
010869962238010621245944000028791727073110245944
010869962238010621245944000028781727073110245944
010869962238010621245944000029741727073110245944
010869962238010621245944000028501727073110245944
010869962238010621245944000029861727073110245944
010869962238010621245944000028471727073110245944
010869962238010621245944000028371727073110245944
010869962238010621245944000030101727073110245944
010869962238010621245944000028721727073110245944
010869962238010621245932000050701727063010245932
010869962238010621245944000028451727073110245944
010869962238010621245944000029361727073110245944
010869962238010621245932000051871727063010245932
010869962238010621245944000028411727073110245944
010869962238010621245944000028711727073110245944
010869962238010621245944000029881727073110245944
010869962238010621245944000028531727073110245944
010869962238010621245944000028461727073110245944
010869962238010621245932000050321727063010245932
010869962238010621245944000029901727073110245944
010869962238010621245932000050961727063010245932
010869962238010621ST0000000779501726033110235918
010869962238010621245932000050561727063010245932
010869962238010621245944000029701727073110245944
010869962238010621245944000029711727073110245944
010869962238010621245944000029681727073110245944
010869962238010621245944000029691727073110245944
010869962238010621245944000028511727073110245944
010869962238010621ST0000000778261726033110235918
010869962238010621245944000029571727073110245944
010869962238010621245944000030081727073110245944
010869962238010621245944000029391727073110245944
010869962238010621245944000029121727073110245944
010869962238010621ST0000000779211726033110235918
010869962238010621245932000051571727063010245932
010869962238010621245944000029301727073110245944
010869962238010621245944000029031727073110245944
010869962238010621245944000029291727073110245944
010869962238010621245944000029281727073110245944
010869962238010621245944000029271727073110245944
010869951101007721300100113165821729043010A14821
010869951101007721300100113165331729043010A14821
010869951101007721300100113187431729043010A14821
010869951101007721300100113165651729043010A14821
010869951101007721300100113165501729043010A14821
010869951101007721300100113187331729043010A14821
010869951101007721300100113184201729043010A14821
010869951101007721300100113165451729043010A14821
010869951101007721300100113187421729043010A14821
010869951101007721300100113187441729043010A14821
010869951101007721300100113165351729043010A14821
010869951101007721300100113183901729043010A14821
010869951101007721300100113187381729043010A14821
010869951101007721300100113165371729043010A14821
010869951101007721300100113187291729043010A14821
010869951101007721300100113165521729043010A14821
010869951101007721300100113165581729043010A14821
010869951101007721300100113184051729043010A14821
010869951101007721300100113165601729043010A14821
010869951101007721300100113184101729043010A14821
010869951101007721300100113165481729043010A14821
010869951101007721300100113165751729043010A14821
010869951101007721300100113165781729043010A14821
010869951101007721300100113165671729043010A14821
010869951101007721300100113165731729043010A14821
010869951101007721300100113187341729043010A14821
010869951101007721300100113184251729043010A14821
010869951101007721300100113165631729043010A14821
010869951101007721300100113165701729043010A14821
010869951101007721300100113165531729043010A14821
010869951101007721300100113187231729043010A14821
010869951101007721300100113187361729043010A14821
010869951101007721300100113187181729043010A14821
010869951101007721300100113165421729043010A14821
0108699546385492216804558067441726022810ELB02299
0108699546385492216136941428781726022810ELB02299
0108699546385492216230774064021726022810ELB02299
0108699546385492216547872708551726022810ELB02299
0108699546385492216924484795581726022810ELB02299
0108699546385492216340277562641726022810ELB02299
010869960775053521100000007376011727103110220519013
010869960775053521100000006274151726043010210519005
010869960775053521100000006271111726043010210519005
010869960775053521100000006272501726043010210519005
010869960775053521100000006274141726043010210519005
010869960775053521100000006272661726043010210519005
010869960775053521100000006272641726043010210519005
010869960775053521100000006271051726043010210519005
010869960775053521100000006272521726043010210519005
010869960775053521100000007375951727103110220519013
010869960775053521100000006272651726043010210519005
010869960775053521100000007376041727103110220519013
010869960775053521100000007376051727103110220519013
010869960775053521100000007376031727103110220519013
010869960775053521100000006271091726043010210519005
010869952575524721500100201577911728043010A24400
010869952575524721500100201578541728043010A24400
010869952575524721500100201578101728043010A24400
010869952575524721500100201577601728043010A24400
010869952575524721500100201576961728043010A24400
010869952575524721500100201577221728043010A24400
010869952575524721500100201577471728043010A24400
010869952575524721500100201577611728043010A24400
010869952575524721500100201578141728043010A24400
010869952575524721500100201577381728043010A24400
010869952575524721500100201578551728043010A24400
010869952575524721500100201577841728043010A24400
010869952575524721500100201576861728043010A24400
010869952575524721500100201577321728043010A24400
010869952575524721500100201577201728043010A24400
010869952575524721500100201577901728043010A24400
010869952575524721500100201578281728043010A24400
010869952575524721500100201577961728043010A24400
010869952575524721500100201576801728043010A24400
010869952575524721500100201577661728043010A24400
010869952575524721500100201578041728043010A24400
010869952575524721500100201577781728043010A24400
010869952575524721500100201577041728043010A24400
010869952575524721500100201577691728043010A24400
010869952575524721500100201577261728043010A24400
010869952575524721500100201577971728043010A24400
010869952575524721500100201577721728043010A24400
010869952575524721500100201578201728043010A24400
010869952575524721500100201576921728043010A24400
010869952575524721500100201577811728043010A24400
010869952575524721500100201577341728043010A24400
010869952575524721500100201578531728043010A24400
010869952575524721500100201577141728043010A24400
010869952575524721500100201578211728043010A24400
0108680184790236216000001447744617270331105197005
0108680184790236216000001447738217270331105197005
0108680184790236216000001447732217270331105197005
0108680184790236216000001447728817270331105197005
0108680184790236216000001418555917270228105197003
0108680184790236216000001418556417270228105197003
0108680184790236216000001418557317270228105197003
0108680184790236216000001447739917270331105197005
0108680184790236216000001447733917270331105197005
0108680184790236216000001418556217270228105197003
0108680184790236216000001418540217270228105197003
0108680184790236216000001447738717270331105197005
0108680184790236216000001418555417270228105197003
0108680184790236216000001447739817270331105197005
0108680184790236216000001447736517270331105197005
0108680184790236216000001447734417270331105197005
0108680184790236216000001418558917270228105197003
0108680184790236216000001418560017270228105197003
0108680184790236216000001418560117270228105197003
0108680184790236216000001447745017270331105197005
0108680184790236216000001418505917270228105197003
0108680184790236216000001418540617270228105197003
0108680184790236216000001418559617270228105197003
0108680184790236216000001447734917270331105197005
0108680184790236216000001447731117270331105197005
0108680184790236216000001447740917270331105197005
0108680184790236216000001418559517270228105197003
0108680184790236216000001418555117270228105197003
0108680184790236216000001447729617270331105197005
0108680184790236216000001447732317270331105197005
0108680184790236216000001447732417270331105197005
0108680184790236216000001447732117270331105197005
0108680184790236216000001447740417270331105197005
0108680184790236216000001447734017270331105197005
0108680184790236216000001447731217270331105197005
0108680184790236216000001418556117270228105197003
0108680184790236216000001447729317270331105197005
0108680184790236216000001447730017270331105197005
0108680184790236216000001447744517270331105197005
0108680184790236216000001447729017270331105197005
0108680184790236216000001418559417270228105197003
0108680184790236216000001447731917270331105197005
0108680184790236216000001447740717270331105197005
0108680184790236216000001418540417270228105197003
0108680184790236216000001418561617270228105197003
0108680184790236216000001418560317270228105197003
0108680184790236216000001418559217270228105197003
0108680184790236216000001418543017270228105197003
0108680184790236216000001418561117270228105197003
0108680184790236216000001447730917270331105197005
0108680184790236216000001418556317270228105197003
0108680184790236216000001447729217270331105197005
0108680184790236216000001418558517270228105197003
0108680184790236216000001447733717270331105197005
0108680184790236216000001447730417270331105197005
0108680184790236216000001447730117270331105197005
0108680184790236216000001418557717270228105197003
0108680184790236216000001418558717270228105197003
0108680184790236216000001447736417270331105197005
0108680184790236216000001447730717270331105197005
0108680184790236216000001447731417270331105197005
0108680184790236216000001418555717270228105197003
0108680184790236216000001418539917270228105197003
0108680184790236216000001447728417270331105197005"""

def load_medications_db():
    with open('data/medications_barcode.json', 'r', encoding='utf-8') as f:
        return json.load(f)

def parse_datamatrix(barcode):
    result = {"gtin": None, "serial_number": None, "lot_number": None, "expiry_date": None, "raw": barcode}
    if not barcode: return result
    barcode = barcode.strip()
    if len(barcode) == 13 and barcode.isdigit():
        result["gtin"] = barcode
        result["serial_number"] = f"EAN-{barcode}-{uuid.uuid4().hex[:8]}"
        return result
    if barcode.startswith('01') and len(barcode) >= 16:
        result["gtin"] = barcode[2:16]
        rest = barcode[16:]
        if rest.startswith('21'):
            serial_end = len(rest)
            for ai in ['17', '10']:
                idx = rest.find(ai, 2)
                if idx > 2 and idx < serial_end: serial_end = idx
            result["serial_number"] = rest[2:serial_end]
            rest = rest[serial_end:]
        if '17' in rest:
            idx = rest.find('17')
            if idx >= 0 and len(rest) >= idx + 8:
                try:
                    exp = rest[idx+2:idx+8]
                    result["expiry_date"] = datetime(2000+int(exp[0:2]), int(exp[2:4]), max(1, int(exp[4:6])))
                except: pass
        if '10' in rest:
            idx = rest.find('10')
            if idx >= 0:
                lot_end = len(rest)
                for ai in ['17', '21']:
                    ai_idx = rest.find(ai, idx+2)
                    if ai_idx > idx and ai_idx < lot_end: lot_end = ai_idx
                result["lot_number"] = rest[idx+2:lot_end]
    if not result["serial_number"]: result["serial_number"] = f"RAW-{barcode[:20]}"
    return result

def get_med_name(gtin, db):
    if not gtin: return None
    if gtin in db: return db[gtin]
    if len(gtin) == 14 and gtin.startswith('0') and gtin[1:] in db: return db[gtin[1:]]
    return None

async def bulk_add():
    from motor.motor_asyncio import AsyncIOMotorClient
    barcodes = [b.strip() for b in ALL_BARCODES.strip().split('\n') if b.strip()]
    client = AsyncIOMotorClient('mongodb+srv://healmedy_user:H3alm3dy2024!@abro.lwzasyg.mongodb.net/')
    db = client['healmedy_hbys']
    meds = load_medications_db()
    print(f"PART 4: {len(barcodes)} karekod, {len(meds)} ilac")
    results = {"success": 0, "exists": 0, "unknown": 0}
    summary = defaultdict(lambda: {"name": "", "count": 0})
    for i, bc in enumerate(barcodes):
        if not bc: continue
        try:
            p = parse_datamatrix(bc)
            gtin, serial = p.get("gtin"), p.get("serial_number")
            if await db.barcode_stock.find_one({"serial_number": serial, "gtin": gtin}):
                results["exists"] += 1
                continue
            name = get_med_name(gtin, meds)
            if not name:
                results["unknown"] += 1
                name = f"Bilinmeyen ({gtin[-6:] if gtin else 'N/A'})"
            summary[gtin]["name"] = name
            summary[gtin]["count"] += 1
            sid = str(uuid.uuid4())
            await db.barcode_stock.insert_one({
                "_id": sid, "gtin": gtin or "", "serial_number": serial,
                "lot_number": p.get("lot_number"), "expiry_date": p.get("expiry_date"),
                "name": name, "location": "merkez_depo", "location_detail": "Ana Depo",
                "status": "available", "added_at": datetime.utcnow(), "added_by": "bulk_import",
                "added_by_name": "Toplu Ice Aktarma", "raw_barcode": bc
            })
            await db.stock.insert_one({
                "_id": str(uuid.uuid4()), "name": name, "code": gtin[:8] if gtin else serial[:8],
                "gtin": gtin, "quantity": 1, "min_quantity": 1, "location": "merkez_depo",
                "location_detail": "Ana Depo", "lot_number": p.get("lot_number"),
                "serial_number": serial, "expiry_date": p.get("expiry_date"),
                "qr_code": sid, "unit": "adet", "created_at": datetime.utcnow(),
                "updated_at": datetime.utcnow(), "barcode_stock_id": sid
            })
            results["success"] += 1
            if (i+1) % 100 == 0: print(f"  {i+1}/{len(barcodes)}")
        except: results["unknown"] += 1
    client.close()
    print(f"\nSONUC: {results['success']} eklendi, {results['exists']} mevcut, {results['unknown']} bilinmeyen")
    for g, i in sorted(summary.items(), key=lambda x: x[1]['count'], reverse=True)[:20]:
        print(f"  {i['count']:3d}x {i['name'][:55]}")
    print("TAMAMLANDI!")

if __name__ == "__main__":
    asyncio.run(bulk_add())


