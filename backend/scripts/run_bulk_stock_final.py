"""
Toplu Stok GiriÅŸi - Son Kalan Karekodlar
"""
import sys, os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
os.chdir(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

import asyncio, json, uuid
from datetime import datetime
from collections import defaultdict

ALL = """01086804007706772124693016032662172611301024693016
01086804007706772124693016032692172611301024693016
01086804007706772124693016032680172611301024693016
01086804007706772124693016186569172611301024693016
01086804007706772124693016186557172611301024693016
01086804007706772124693016186587172611301024693016
01086804007706772124693016186563172611301024693016
01086804007706772124693016186581172611301024693016
01086804007706772124693016186575172611301024693016
01086804007706772124693016186605172611301024693016
01086804007706772124693016186599172611301024693016
01086804007706772124693016186593172611301024693016
01086804007706772124693016186611172611301024693016
01086804007706772124693016187868172611301024693016
01086804007706772124693016188240172611301024693016
01086804007706772124693016188306172611301024693016
01086804007706772124693016188285172611301024693016
01086804007706772124693016188501172611301024693016
01086804007706772124693016188417172611301024693016
01086804007706772124693016188414172611301024693016
01086804007706772124693016188489172611301024693016
01086804007706772124693016188492172611301024693016
01086804007706772124693016188495172611301024693016
01086995067520502160430008024410173002281025002
010869950675205021R0000000018972172810311023008
010869950675205021R0000000215145172909301024002
01086995067520502160430008062410173002281025002
01086995067520502160430008048310173002281025002
01086995067520502160430008048510173002281025002
01086995067520502160430008034810173002281025002
01086995067520502160430008000110173002281025002
01086995067520502160430008034910173002281025002
01086995067520502160430001874610173002281025001
01086995067520502160430008048110173002281025002
01086995067520502160430008048210173002281025002
01086995067520502160430008048610173002281025002
01086995067520502160430008035010173002281025002
01086995067520502160430008000210173002281025002
010869950601205521C0000035377669172804301023026
010869950601205521R0000012428486173005311025033
010869950601205521R0000012428420173005311025033
010869950601205521C0000037884268172807311023051
010869950601205521R0000012428479173005311025033
010869950601205521R0000012428477173005311025033
010869950601205521R0000012428419173005311025033
010869950601205521R0000012428482173005311025033
010869950601205521R0000012428418173005311025033
010869952515146921300100219988651729053110A16394
010869952515146921300100219999181729053110A16394
010869952515146921300100219999251729053110A16394
010869952515146921300100219988761729053110A16394
010869952515146921300100219998781729053110A16394
010869952515146921300100219998911729053110A16394
010869952515146921300100219999591729053110A16394
010869952515146921300100219988681729053110A16394
010869952515146921300100219999361729053110A16394
010869952515146921300100219988861729053110A16394
010869952515146921300100219988711729053110A16394
010869952515146921300100219999291729053110A16394
010869952515146921300100219999111729053110A16394
010869952515146921300100219988981729053110A16394
010869952515146921300100219989501729053110A16394
010869952515146921300100219998771729053110A16394
010869952515146921300100219989031729053110A16394
010869952515146921300100219998861729053110A16394
010869952515146921300100219988831729053110A16394
010869952515146921300100219989081729053110A16394
010869952515146921300100219999601729053110A16394
010869952515146921300100219989091729053110A16394
010869952515146921300100219988881729053110A16394
010869952515146921300100219999141729053110A16394
010869952515146921300100219998811729053110A16394
010869952515146921300100219988691729053110A16394
010869952515146921300100219989401729053110A16394
010869952515146921300100219998731729053110A16394
010869952515146921300100219999461729053110A16394
010869952515146921300100219989551729053110A16394
010869952515146921300100219988891729053110A16394
010869952515146921300100219999241729053110A16394
010869952515146921300100219988931729053110A16394
010869952515146921300100219999281729053110A16394
010869952515146921300100219998671729053110A16394
010869952515146921300100219988991729053110A16394
010869952515146921300100219988821729053110A16394
010869952515146921300100219998711729053110A16394
010869952515146921300100219999541729053110A16394
010869952515146921300100219999201729053110A16394
010869952515146921300100219988731729053110A16394
010869952515146921300100219988701729053110A16394
010869952515146921300100219988631729053110A16394
010869952515146921300100219999231729053110A16394
010869952515146921300100219988641729053110A16394
010869952515146921300100219999191729053110A16394
010869952515146921300100219999511729053110A16394
010869952515146921300100219998921729053110A16394
010869952515146921300100219999151729053110A16394
010869952515146921300100219998681729053110A16394
010869952515146921300100219998761729053110A16394
010869952515146921300100219999121729053110A16394
010869952515146921300100219988901729053110A16394
010869952515146921300100219988871729053110A16394
010869952515146921300100219999391729053110A16394
010869952515146921300100219999401729053110A16394
010869952515146921300100219999551729053110A16394
010869952515146921300100219999331729053110A16394
010869952515146921300100219988741729053110A16394
010869952515146921300100219988771729053110A16394
010869952515146921300100219999641729053110A16394
010869952515146921300100219998871729053110A16394
010869952515146921300100219999021729053110A16394
010869952515146921300100219999341729053110A16394
010869952515146921300100219988811729053110A16394
010869952515146921300100219999061729053110A16394
010869952515146921300100219998841729053110A16394
010869952515146921300100219998901729053110A16394
010869952515146921300100219988781729053110A16394
010869952515146921300100219998961729053110A16394
010869952515146921300100219989361729053110A16394
010869952515146921300100219998971729053110A16394
010869952515146921300100219999351729053110A16394
010869952515146921300100219999521729053110A16394
010869952515146921300100219998821729053110A16394
010869952515146921300100219988851729053110A16394
010869952515146921300100219998721729053110A16394
010869952515146921300100219988801729053110A16394
010869952515146921300100219999611729053110A16394
01086995691501832119000012405647172907311025082007A
01086995691501832119000012405632172907311025082007A
01086995691501832119000012405663172907311025082007A
01086995691501832119000012405680172907311025082007A
01086995691501832119000012405615172907311025082007A
01086995691501832119000012405650172907311025082007A
01086995691501832119000012405635172907311025082007A
01086995691501832119000012405665172907311025082007A
01086995691501832119000012405682172907311025082007A
01086995691501832119000012405652172907311025082007A
01086995691501832119000012405684172907311025082007A
01086995691501832119000012405670172907311025082007A
01086995691501832119000012405618172907311025082007A
01086995691501832119000012405657172907311025082007A
01086995691501832119000012405620172907311025082007A
01086995691501832119000012405675172907311025082007A
01086995691501832119000012405637172907311025082007A
01086995691501832119000004396622172609301022082018A
0108699541770408216000005171181C172802291025C021111
0108699541770408216000005746911C172802291025C021111
0108699541770408216000005171331C172802291025C021111
010869982819005921700000001275171728073110170125 05
010869962475001321253103000942161730022810250601011
010869962475001321253103000942201730022810250601011
010869962475001321253103000942391730022810250601011
010869962475001321253103000941621730022810250601011
010869962475001321253103000942011730022810250601011
010869962475001321253103000942141730022810250601011
010869962475001321253103000942121730022810250601011
010869962475001321253103000941891730022810250601011
010869962475001321253103000942171730022810250601011
010869962475001321253103000941811730022810250601011
01086830607501022114573R7W69G3881727093010ELB90081
01086830607501022114573R7W69XK4H1727093010ELB90081
01086830607501022114573R7W69MNP71727093010ELB90081
01086830607501022114573R7W6A264D1727093010ELB90081
0108699369070056213700000063305317172609301023N156
0108699369070056213700000063305333172609301023N156
0108699369070056213700000063305338172609301023N156
0108699369070056213700000063305343172609301023N156
0108699369070056213700000063305348172609301023N156
0108699369070056213700000063305353172609301023N156
0108699369070056213700000063305347172609301023N156
0108699369070056213700000063305352172609301023N156
0108699369070056213700000063305346172609301023N156
0108699369070056213700000063305341172609301023N156
0108699369070056213700000063305342172609301023N156
0108699369070056213700000063305337172609301023N156
0108699369070056213700000063305332172609301023N156
0108699369070056213700000063305336172609301023N156
0108699369070056213700000063305331172609301023N156
0108699369070056213700000063305330172609301023N156
0108699369070056213700000063305335172609301023N156
0108699369070056213700000063305345172609301023N156
0108699369070056213700000063305340172609301023N156
0108699369070056213700000063305351172609301023N156
0108699369070056213700000063305350172609301023N156
0108699369070056213700000063305334172609301023N156
0108699369070056213700000063305329172609301023N156
0108699369070056213700000063305339172609301023N156
0108699369070056213700000063305344172609301023N156
0108699369070056213700000063305349172609301023N156
0108699369070056213700000063305323172609301023N156
0108699369070056213700000063305318172609301023N156
0108699369070056213700000063305328172609301023N156
010869954309028321AR160010965577172612311025010007
010869954309028321AR160010965633172612311025010007
010869977252574721252235003222109172604301024T769
010869977252574721252235000375854172604301024T769
01086804007703872125698014205960172707311025698014
01086804007703872125698014205969172707311025698014
01086804007703872125698014205963172707311025698014
01086804007703872125698014205981172707311025698014
01086804007703872125698014205987172707311025698014
01086804007703872125698014205996172707311025698014
01086804007703872125698014205978172707311025698014
01086804007703872125698014206005172707311025698014
01086804007703872125698014206014172707311025698014
01086804007703872125698014205999172707311025698014
01086804007703872125698014206023172707311025698014
01086804007703872125698014206002172707311025698014
01086804007703872125698014206029172707311025698014
01086804007703872125698014206026172707311025698014
01086804007703872125698014206020172707311025698014
01086804007703872125698014206008172707311025698014
01086804007703872125698014205990172707311025698014
01086804007703872125698014206011172707311025698014
01086804007703872125698014205984172707311025698014
01086804007703872125698014205993172707311025698014
01086804007703872125698014206017172707311025698014
010869968004003521I00361005916707217290630102500720035
010869968004003521I00361005916709617290630102500720035
010869968004003521I00361005916708817290630102500720035
010868306089005121145341914R24CE1727033110FLB01905
01086804007709432125156036000622172701311025156036
01086804007709432125156004003916172612311025156004
01086804007709432125156004003910172612311025156004
01086804007709432125156004003919172612311025156004
01086804007709432125156004003904172612311025156004
01086804007709432125156050006991172704301025156050
01086804007709432125156050007108172704301025156050
01086804007709432125156050007000172704301025156050
01086804007709432125156050007126172704301025156050
01086804007709432125156050007003172704301025156050
01086804007709432125156050006982172704301025156050
01086804007709432125156050007111172704301025156050
01086804007709432125156050006994172704301025156050
01086804007709432125156050007006172704301025156050
01086804007709432125156050006988172704301025156050
01086804007709432125156050007120172704301025156050
01086804007709432125156050006985172704301025156050
01086804007709432125156036000607172701311025156036
01086804007709432125156036000616172701311025156036
01086804007709432125156050007117172704301025156050
01086804007709432125156036000604172701311025156036
01086804007709432125156036000610172701311025156036
01086804007709432125156050007123172704301025156050
01086804007709432125156050006970172704301025156050
01086804007709432125156050006940172704301025156050
01086804007709432125156050006952172704301025156050
010869971769001121121303181727070810251899
010869971769001121121303141727070810251899
010869971769001121121303151727070810251899
010869971769001121121303191727070810251899
010869971770006221489408591726113010234308
010869971770006221489408641726113010234308
010869971770006221520843351727083010243002
01086996067746932159410019149011726123110E00390002A
01086996067746932159410017751191726123110E00380001A
01086996067746932159410017751301726123110E00380001A"""

def load_meds():
    with open('data/medications_barcode.json', 'r', encoding='utf-8') as f:
        return json.load(f)

def parse(bc):
    r = {"gtin": None, "serial_number": None, "lot_number": None, "expiry_date": None, "raw": bc}
    if not bc: return r
    bc = bc.strip()
    if len(bc) == 13 and bc.isdigit():
        r["gtin"] = bc; r["serial_number"] = f"EAN-{bc}-{uuid.uuid4().hex[:8]}"; return r
    if bc.startswith('01') and len(bc) >= 16:
        r["gtin"] = bc[2:16]; rest = bc[16:]
        if rest.startswith('21'):
            se = len(rest)
            for ai in ['17', '10']:
                idx = rest.find(ai, 2)
                if idx > 2 and idx < se: se = idx
            r["serial_number"] = rest[2:se]; rest = rest[se:]
        if '17' in rest:
            idx = rest.find('17')
            if idx >= 0 and len(rest) >= idx + 8:
                try:
                    e = rest[idx+2:idx+8]
                    r["expiry_date"] = datetime(2000+int(e[0:2]), int(e[2:4]), max(1, int(e[4:6])))
                except: pass
        if '10' in rest:
            idx = rest.find('10')
            if idx >= 0:
                le = len(rest)
                for ai in ['17', '21']:
                    ai_idx = rest.find(ai, idx+2)
                    if ai_idx > idx and ai_idx < le: le = ai_idx
                r["lot_number"] = rest[idx+2:le]
    if not r["serial_number"]: r["serial_number"] = f"RAW-{bc[:20]}"
    return r

def get_name(gtin, db):
    if not gtin: return None
    if gtin in db: return db[gtin]
    if len(gtin) == 14 and gtin.startswith('0') and gtin[1:] in db: return db[gtin[1:]]
    return None

async def main():
    from motor.motor_asyncio import AsyncIOMotorClient
    bcs = [b.strip() for b in ALL.strip().split('\n') if b.strip()]
    client = AsyncIOMotorClient('mongodb+srv://healmedy_user:H3alm3dy2024!@abro.lwzasyg.mongodb.net/')
    db = client['healmedy_hbys']
    meds = load_meds()
    print(f"FINAL: {len(bcs)} karekod")
    res = {"success": 0, "exists": 0, "unknown": 0}
    sm = defaultdict(lambda: {"name": "", "count": 0})
    for i, bc in enumerate(bcs):
        if not bc: continue
        try:
            p = parse(bc)
            g, s = p.get("gtin"), p.get("serial_number")
            if await db.barcode_stock.find_one({"serial_number": s, "gtin": g}):
                res["exists"] += 1; continue
            n = get_name(g, meds)
            if not n:
                res["unknown"] += 1
                n = f"Bilinmeyen ({g[-6:] if g else 'N/A'})"
            sm[g]["name"] = n; sm[g]["count"] += 1
            sid = str(uuid.uuid4())
            await db.barcode_stock.insert_one({
                "_id": sid, "gtin": g or "", "serial_number": s,
                "lot_number": p.get("lot_number"), "expiry_date": p.get("expiry_date"),
                "name": n, "location": "merkez_depo", "location_detail": "Ana Depo",
                "status": "available", "added_at": datetime.utcnow(), "added_by": "bulk_import",
                "added_by_name": "Toplu Ice Aktarma", "raw_barcode": bc
            })
            await db.stock.insert_one({
                "_id": str(uuid.uuid4()), "name": n, "code": g[:8] if g else s[:8],
                "gtin": g, "quantity": 1, "min_quantity": 1, "location": "merkez_depo",
                "location_detail": "Ana Depo", "lot_number": p.get("lot_number"),
                "serial_number": s, "expiry_date": p.get("expiry_date"),
                "qr_code": sid, "unit": "adet", "created_at": datetime.utcnow(),
                "updated_at": datetime.utcnow(), "barcode_stock_id": sid
            })
            res["success"] += 1
        except: res["unknown"] += 1
    client.close()
    print(f"\nSONUC: {res['success']} eklendi, {res['exists']} mevcut")
    for g, i in sorted(sm.items(), key=lambda x: x[1]['count'], reverse=True)[:15]:
        print(f"  {i['count']:3d}x {i['name'][:55]}")
    print("TAMAMLANDI!")

if __name__ == "__main__":
    asyncio.run(main())





