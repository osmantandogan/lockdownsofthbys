"""
Toplu Stok GiriÅŸi - Kalan Karekodlar (Part 2)
"""

import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
os.chdir(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

import asyncio
import json
import uuid
from datetime import datetime
from typing import Dict, List
from collections import defaultdict

ALL_BARCODES = """0108699546130238216915053232321726073110CLB04370
0108699546130238216999494918021726073110CLB04370
0108699546130238216362522728841726022810CLB01982
0108699546130238216010681961871726022810CLB01982
0108699546130238216216394289611726022810CLB01982
0108699546130238216244170239931726022810CLB01982
0108699546130238216095205282541726022810CLB01982
0108699546130238216489727268781726022810CLB01982
0108699546130238216862277898781726022810CLB01982
0108699546130238216165065651321726073110CLB04370
0108699546130238216528862151711726073110CLB04370
0108699546130238216507062729741725103110BLB06680
0108699546130238216328892815951725103110BLB06680
010869984452116521110000163426681726033110404082
010869984452116521110000163426661726033110404082
010869956609338421200000334738431726091310N1845011
010869956609338421200000334737941726091310N1845011
010869956609338421200000334738061726091310N1845011
010869956609338421200000334738101726091310N1845011
010869956609338421200000334738661726091310N1845011
0108699788750324212580016242404331727073110H2562401
0108699788750324212580016242404411727073110H2562401
0108699788750324212580016242404351727073110H2562401
0108699788750324212580016242404481727073110H2562401
0108699788750324212580016242404371727073110H2562401
0108699788750324212580016242404461727073110H2562401
0108699788750324212580016242404431727073110H2562401
0108699788750324212580016242404401727073110H2562401
0108699788750324212580016242404251727073110H2562401
0108699788750324212580016242404451727073110H2562401
0108699788750324212580016242404471727073110H2562401
0108699788750324212580016242404391727073110H2562401
0108699788750324212580016242404321727073110H2562401
0108699788750324212580016242404341727073110H2562401
0108699788750324212580016242404361727073110H2562401
0108699788750324212580016242404261727073110H2562401
0108699788750324212580016242404281727073110H2562401
0108699788750324212580016242404301727073110H2562401
0108699788750324212580016242404051727073110H2562401
0108699788750324212580016242404421727073110H2562401
0108699788750324212580016242404291727073110H2562401
0108699788750324212580016242404271727073110H2562401
0108699788750324212580016242404311727073110H2562401
0108699788750324212580016242404441727073110H2562401
0108699788750324212580016242609931727073110H2562401
0108699788750324212580016242609841727073110H2562401
0108699788750324212580016242609861727073110H2562401
0108699788750324212580016242609871727073110H2562401
0108699788750324212580016242609911727073110H2562401
0108699788750324212580016242609891727073110H2562401
0108699788750324212580016242609991727073110H2562401
0108699788750324212580016242609971727073110H2562401
0108699788750324212580016242609951727073110H2562401
0108699788750324212580016242610051727073110H2562401
0108699788750324212580016242610031727073110H2562401
0108699788750324212580016242610011727073110H2562401
0108699788750324212580016242610001727073110H2562401
0108699788750324212580016242610041727073110H2562401
0108699788750324212580016242610021727073110H2562401
0108699788750324212580016242609941727073110H2562401
0108699788750324212580016242609961727073110H2562401
0108699788750324212580016242609981727073110H2562401
0108699788750324212580016242609901727073110H2562401
0108699788750324212580016242609881727073110H2562401
0108699788750324212580016242609921727073110H2562401
0108699788750324212580016242609831727073110H2562401
0108699788750324212580016242609851727073110H2562401
0108699788750324212580016242607001727073110H2562401
0108699788750324212580016242589121727073110H2562401
0108699788750324212580016242494461727073110H2562401
0108699788750324212580016242592131727073110H2562401
0108699788750324212580016242591351727073110H2562401
0108699788750324212580016242586581727073110H2562401
0108699788750324212580016242586571727073110H2562401
0108699788750324212580016242592151727073110H2562401
0108699788750324212580016242592161727073110H2562401
0108699788750324212580016242592141727073110H2562401
0108699788750324212580016242592171727073110H2562401
0108699788750324212580016242592191727073110H2562401
0108699788750324212580016242592211727073110H2562401
0108699788750324212580016242592221727073110H2562401
0108699788750324212580016242592201727073110H2562401
0108699788750324212580016242592181727073110H2562401
0108699788750324212580016242591891727073110H2562401
0108699788750324212580016242591631727073110H2562401
0108699788750324212580016242592231727073110H2562401
0108699788750324212580016242591871727073110H2562401
0108699788750324212580016242591901727073110H2562401
0108699788750324212580016242592101727073110H2562401
0108699788750324212580016242503921727073110H2562401
0108699788750324212580016242513521727073110H2562401
0108699788750324212580016242591381727073110H2562401
0108699788750324212580016242597491727073110H2562401
0108699788750324212580016242597451727073110H2562401
0108699788750324212580016242597471727073110H2562401
0108699788750324212580016242597391727073110H2562401
0108699788750324212580016242597411727073110H2562401
0108699788750324212580016242597431727073110H2562401
0108699788750324212580016242597341727073110H2562401
0108699788750324212580016242597361727073110H2562401
010869971709029321365622491728031810250967
010869971709029321365622421728031810250967
010869971709029321365622261728031810250967
010869971709029321365622441728031810250967
010869971709029321365622381728031810250967
010869971709029321365622271728031810250967
0108699792341235219799100530280917271231100029
0108699792341235219799100474504817270930104507
0108699792341235219799100474507317270930104507
0108699792341235219799100474502917270930104507
0108699792341235219799100530280617271231100029
0108699792341235219799100474503917270930104507
0108699792341235219799100474503217270930104507
0108699792341235219799100530275617271231100029
0108699792341235219799100474504317270930104507
0108699792341235219799100474506517270930104507
0108699792341235219799100474502717270930104507
0108699792341235219799100474503517270930104507
0108699792341235219799100474506817270930104507
010869970875181321000000002442891727043010F002
0108699541791700216000004407341C172602281024C035321
0108699541791700216000004407671C172602281024C035321
0108699541791700216000004407431C172602281024C035321
010868306057002121145H44WP45A5N11727063010FLB03671
010868306057002121145H44WP44GH0R1727063010FLB03671
010868306057002121145H44WP4593DV1727063010FLB03671
0108680400770578212599679009016860172706301025679009
010869980909857221145D43V7C4RD1K1727053110FLB03180
010869980909857221145D43V7C3G0DP1727053110FLB03180
010869980909857221145D43V7C539M21727053110FLB03180
010869980909857221145D43V7C5N81C1727053110FLB03180
010869980909857221145D43V7C5C3T01727053110FLB03180
010869980909857221145D43V7C61HHM1727053110FLB03180
010869980909857221145D43V7C45PW11727053110FLB03180
010869980909857221145D43V7C4E0041727053110FLB03180
010869980909857221145D43V7C3VKTG1727053110FLB03180
010868018452020821050000174260011726113010413102
010868018452020821050000174259881726113010413102
010868018452020821050000175198051726123110413109
010868018452020821050000174259481726113010413102
010868018452020821050000174259551726113010413102
010868018452020821050000175248051726123110413109
010868018452020821050000175248001726123110413109
010868018452020821050000175247961726123110413109
010868018452020821050000175247991726123110413109
010868018452020821050000175247981726123110413109
010868018452020821050000174259561726113010413102
010868018452020821050000173090461726103110413099
010868018452020821050000173090421726103110413099
010868018452020821050000173090511726103110413099
010868018452020821050000175198251726123110413109
010868018452020821050000175227111726123110413109
010868018452020821050000175247871726123110413109
010868018452020821050000175198121726123110413109
01086995693501182154000000854888172709301024442006A
01086995693501182154000000843241172709301024442006A
01086995693501182154000000852846172709301024442006A
010869057008107721D00581005151061727040010AHD893
010869057008107721D00581005150371727040010AHD893
010869057008107721D00581005151521727040010AHD893
010869057008107721D00581005150601727040010AHD893
01086995696101062172566564166209172709301024263018
01086995696101062172566564167009172709301024263018
01086995696101062172566564165309172709301024263018
01086995696101062172566564167809172709301024263018
01086995696101062172566564171009172709301024263018
01086995696101062172566564172509172709301024263018
01086995696101062172566564171709172709301024263018
01086995696101062172566564170109172709301024263018
01086995696101062172566564169309172709301024263018
010869952509236621400100104881451726093010A118150
010869952509236621400100104881201726093010A118150
010869952509236621400100104881081726093010A118150
010869952509236621400100104880831726093010A118150
010869952509236621400100104880651726093010A118150
010869950827022421MEN9NTGYRF6FK617261213102312046
010869950827022421MEN50VH9247C9617261213102312046
010869950827022421MENEGG24PP81PH17261213102312046
010869950827022421MENTPM896XX1GC17261213102312046
010869950827022421MEN1AV16V3TT3W17261213102312046
010869950827022421MENP5ER93VFH7G17261213102312046
010869950827022421MEND5EP4GHC9R917261213102312046
010869950827022421MEN0E9A2K3E8E017261213102312046
010869950827022421MEN9XN38T3FY2W17261213102312046
010869950827022421MENFCN3RM3DY4817261213102312046
010869950827022421MENM3FN79547E217261213102312046
010869950827022421MENP3CDRY30W6217261213102312046
010869950827022421MENCD815CKC50517261213102312046
010869950827022421MEN57XHWRW7W7C17261213102312046
010869950827022421MENV5H3PPW6MG717261213102312046
010869950827022421MEN38F2F8P5F8817261213102312046
010869950827022421MEN4C8125ATV4A17261213102312046
010869950827022421MEN0886HT6RGCP17261213102312046
010869950827022421MEN39W9RR2C2VV17261213102312046
010869950827022421MEN8HFWFTR7FM017261213102312046
010869950827022421MENT3RHDVYDW7217261213102312046
010869950827022421MENVHAW19TM5WT17261213102312046
010869950827022421MEN597ER2R24GD17261213102312046
010869950827022421MEN0FVM3M24KH217261213102312046
010869950827022421MENKKYWV3T1FY317261213102312046
010869950827022421MEN2YXWPDNKCKY17261213102312046
010869950827022421MENFH3FN7KM82Y17261213102312046
010869950827022421MENXKXVC8PPWGT17261213102312046
010869950827022421MEN1DETXFWCDM717261213102312046
010869950827022421MENM35AY0G08D817261213102312046
010869950827022421MENY9E34T09CCX17261213102312046
010869950827022421MENW1AFN38TDPE17261213102312046
010869950827022421MEN3C2XP2FTE9N17261213102312046
010869950827022421MENRY37CW3D2GK17261213102312046
010869950827022421MENG7E6VT4MGF717261213102312046
0108680712750060210000000474724617260531102306044
0108680712750060210000000474721017260531102306044
0108680712750060210000000474721517260531102306044
0108680712750060210000000474724417260531102306044
0108680712750060210000000474725117260531102306044
0108680712750060210000000474721717260531102306044
0108680712750060210000000474724217260531102306044
0108680712750060210000000474724817260531102306044
0108680712750060210000000474724717260531102306044
0108680712750060210000000474724917260531102306044
0108680712750060210000000474720817260531102306044
0108680712750060210000000474724517260531102306044
0108680712750060210000000474724317260531102306044
0108680712750060210000000474669917260531102306044
0108680712750060210000000474669717260531102306044
0108680712750060210000000474670117260531102306044
0108680712750060210000000474669517260531102306044
0108680712750060210000000474669317260531102306044
0108680712750060210000000474670017260531102306044
0108680712750060210000000474669617260531102306044
0108680712750060210000000474669817260531102306044
0108680712750060210000000474669217260531102306044
0108680712750060210000000474669417260531102306044
0108680712750060210000000474719217260531102306044
0108680712750060210000000474719417260531102306044
0108680712750060210000000474719617260531102306044
0108680712750060210000000474719817260531102306044
0108680712750060210000000474719917260531102306044
0108680712750060210000000474719517260531102306044
0108680712750060210000000474719317260531102306044
0108680712750060210000000474719717260531102306044
0108680712750060210000000474720117260531102306044
0108680712750060210000000474720017260531102306044
01086995487507932110050023722517270430102405008
01086995487507932110050023722317270430102405008
010869963805421321600010011858121728033110EKSG004A
010869963805421321600010011865761728033110EKSG004A
010869963805421321600010011865671728033110EKSG004A
010869963805421321600010011858461728033110EKSG004A
010869963805421321600010011865511728033110EKSG004A
010869963805421321600010011865751728033110EKSG004A
010869963805421321600010011865831728033110EKSG004A
010869963805421321600010011865521728033110EKSG004A
010869958775146121000000290146991727103110F079
010869958775146121000000290147061727103110F079
010869958775146121000000294002421727113010F091
010869958775146121000000271946671727022810F022
010869958775146121000000290147531727103110F079
010869958775146121000000290147231727103110F079
010869958775146121000000290147321727103110F079
010869958775146121000000294002681727113010F091
010869958775146121000000294002141727113010F091
010869958775146121000000294002541727113010F091
010869958775146121000000294002281727113010F091
010869958775146121000000290147371727103110F079
01086995410102072160000055911372172905311025F049811
01086995410102072160000055910372172905311025F049811
01086995410102072160000055910772172905311025F049811
01086997170901252161782411728081610241899
01086997170901252161782311728081610241899
01086995690903282173000009910783173002281025256296A
01086995690903282173000009910678173002281025256296A
01086995690903282173000007837357172911301024256814A
01086995690903282173000009910795173002281025256296A
01086995690903282173000007837383172911301024256814A
01086995690903282173000007837377172911301024256814A
01086995690903282173000007837375172911301024256814A
01086995690903282173000007837379172911301024256814A
01086995690903282173000007837362172911301024256814A
01086995690903282173000009910799173002281025256296A
01086995690903282173000007837332172911301024256814A"""

def load_medications_db():
    with open('data/medications_barcode.json', 'r', encoding='utf-8') as f:
        return json.load(f)

def parse_datamatrix(barcode: str) -> Dict:
    result = {"gtin": None, "serial_number": None, "lot_number": None, "expiry_date": None, "expiry_date_str": None, "raw": barcode}
    if not barcode:
        return result
    barcode = barcode.strip()
    if len(barcode) == 13 and barcode.isdigit():
        result["gtin"] = barcode
        result["serial_number"] = f"EAN-{barcode}-{uuid.uuid4().hex[:8]}"
        return result
    if barcode.startswith('01') and len(barcode) >= 16:
        result["gtin"] = barcode[2:16]
        rest = barcode[16:]
        if rest.startswith('21'):
            serial_end = len(rest)
            for ai in ['17', '10']:
                idx = rest.find(ai, 2)
                if idx > 2 and idx < serial_end:
                    serial_end = idx
            result["serial_number"] = rest[2:serial_end]
            rest = rest[serial_end:]
        if '17' in rest:
            idx = rest.find('17')
            if idx >= 0 and len(rest) >= idx + 8:
                exp_str = rest[idx+2:idx+8]
                result["expiry_date_str"] = exp_str
                try:
                    year = 2000 + int(exp_str[0:2])
                    month = int(exp_str[2:4])
                    day = int(exp_str[4:6])
                    if day == 0:
                        day = 28
                    result["expiry_date"] = datetime(year, month, day)
                except:
                    pass
        if '10' in rest:
            idx = rest.find('10')
            if idx >= 0:
                lot_end = len(rest)
                for ai in ['17', '21']:
                    ai_idx = rest.find(ai, idx + 2)
                    if ai_idx > idx and ai_idx < lot_end:
                        lot_end = ai_idx
                result["lot_number"] = rest[idx+2:lot_end]
    if not result["serial_number"]:
        result["serial_number"] = f"RAW-{barcode[:20]}"
    return result

def get_medication_name(gtin: str, medications_db: dict) -> str:
    if not gtin:
        return None
    if gtin in medications_db:
        return medications_db[gtin]
    if len(gtin) == 14 and gtin.startswith('0'):
        ean13 = gtin[1:]
        if ean13 in medications_db:
            return medications_db[ean13]
    return None

async def bulk_add_stock(barcodes: List[str]):
    from motor.motor_asyncio import AsyncIOMotorClient
    mongo_url = 'mongodb+srv://healmedy_user:H3alm3dy2024!@abro.lwzasyg.mongodb.net/'
    client = AsyncIOMotorClient(mongo_url)
    db = client['healmedy_hbys']
    stock_collection = db.stock
    barcode_stock_collection = db.barcode_stock
    medications_db = load_medications_db()
    print(f"[INFO] {len(medications_db)} ilac yuklendi")
    results = {"success": 0, "exists": 0, "unknown": 0, "errors": 0}
    gtin_summary = defaultdict(lambda: {"name": "", "count": 0})
    for i, barcode in enumerate(barcodes):
        barcode = barcode.strip()
        if not barcode:
            continue
        try:
            parsed = parse_datamatrix(barcode)
            gtin = parsed.get("gtin")
            serial = parsed.get("serial_number")
            existing = await barcode_stock_collection.find_one({"serial_number": serial, "gtin": gtin})
            if existing:
                results["exists"] += 1
                continue
            med_name = get_medication_name(gtin, medications_db)
            if not med_name:
                results["unknown"] += 1
                med_name = f"Bilinmeyen ({gtin[-6:] if gtin else 'N/A'})"
            gtin_summary[gtin]["name"] = med_name
            gtin_summary[gtin]["count"] += 1
            stock_id = str(uuid.uuid4())
            await barcode_stock_collection.insert_one({
                "_id": stock_id, "gtin": gtin or "", "serial_number": serial,
                "lot_number": parsed.get("lot_number"), "expiry_date": parsed.get("expiry_date"),
                "expiry_date_str": parsed.get("expiry_date_str"), "name": med_name,
                "location": "merkez_depo", "location_detail": "Ana Depo", "status": "available",
                "added_at": datetime.utcnow(), "added_by": "bulk_import",
                "added_by_name": "Toplu Ice Aktarma", "raw_barcode": barcode
            })
            await stock_collection.insert_one({
                "_id": str(uuid.uuid4()), "name": med_name,
                "code": gtin[:8] if gtin else serial[:8], "gtin": gtin, "quantity": 1,
                "min_quantity": 1, "location": "merkez_depo", "location_detail": "Ana Depo",
                "lot_number": parsed.get("lot_number"), "serial_number": serial,
                "expiry_date": parsed.get("expiry_date"), "qr_code": stock_id, "unit": "adet",
                "created_at": datetime.utcnow(), "updated_at": datetime.utcnow(), "barcode_stock_id": stock_id
            })
            results["success"] += 1
            if (i + 1) % 100 == 0:
                print(f"  Islendi: {i + 1}/{len(barcodes)}")
        except Exception as e:
            results["errors"] += 1
    client.close()
    return results, dict(gtin_summary)

def main():
    barcode_list = [b.strip() for b in ALL_BARCODES.strip().split('\n') if b.strip()]
    print(f"\nTOPLU STOK GIRISI PART 2 - {len(barcode_list)} karekod\n")
    results, gtin_summary = asyncio.run(bulk_add_stock(barcode_list))
    print(f"\nSONUC: Basarili={results['success']}, Mevcut={results['exists']}, Bilinmeyen={results['unknown']}, Hata={results['errors']}")
    for gtin, info in sorted(gtin_summary.items(), key=lambda x: x[1]['count'], reverse=True)[:30]:
        print(f"  {info['count']:3d}x {info['name'][:55]}")
    print("\nISLEM TAMAMLANDI!\n")

if __name__ == "__main__":
    main()






