"""
Toplu Stok GiriÅŸi - Kalan Son Karekodlar
"""
import sys, os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
os.chdir(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

import asyncio, json, uuid
from datetime import datetime
from collections import defaultdict

ALL = """01086998287501542170000001783849172707311014352542
01086998287501542170000001783879172707311014352542
01086998287501542170000002150513172707311014352545
01086998287501542170000002150383172707311014352545
01086998287501542170000000270869172705311014352528
01086998287501542170000001783878172707311014352542
01086998287501542170000000270879172705311014352528
01086998287501542170000001783859172707311014352542
010869984452104221050000157381601726033110432042
010869984452104221050000157380871726033110432042
010869954001130421100010024610471729063010DDC0003A
010869954001130421100010024610551729063010DDC0003A
010869954001130421100010024610511729063010DDC0003A
010869954001130421100010024610431729063010DDC0003A
010869954001130421100010024610591729063010DDC0003A
01086995412711342160000163895572172609301024I067801
01086995412711342160000163894472172609301024I067801
01086995412711342160000163894972172609301024I067801
01086995412711342160000163895472172609301024I067801
01086995412711342160000163893872172609301024I067801
01086995412711342160000163894372172609301024I067801
01086995412711342160000163895172172609301024I067801
01086995412711342160000163895072172609301024I067801
01086995412711342160000163894272172609301024I067801
01086995412711342160000163893772172609301024I067801
01086995412711342160000163893672172609301024I067801
01086995412711342160000163894872172609301024I067801
010869958775179921A000A10001HGFV1730063010I035
010869958775179921A000A10001KCAH1730063010I035
010869958775179921A000A10001KD0X1730063010I035
010869958775179921A000A10001HG2A1730063010I035
010869958775179921A000A10001HPG61730063010I035
010869958775179921A000A10001KFW11730063010I035
010869958775179921A000A10001HV6G1730063010I035
010869958775179921A000A10001HXP91730063010I035
010869958775179921A000A10001K7YG1730063010I035
010869958775179921A000A10001HXY41730063010I035
010869958775179921A000A10001HD1X1730063010I035
010869958775179921A000A10001K85V1730063010I035
010869958775179921A000A10001KEP51730063010I035
010869958775179921A000A10001HX8R1730063010I035
010869958775179921A000A10001HKEP1730063010I035
010869958775179921A000A10001KH041730063010I035
010869958775179921A000A10001HFH71730063010I035
010869958775179921A000A10001HGXA1730063010I035
010869958775179921A000A10001K4301730063010I035
010869958775179921A000A10001HFGY1730063010I035
010869958775167621000000002141121727063010F004
010869958775167621000000002051611727063010F003
010869958775167621000000002141061727063010F004
010869958775167621000000002141271727063010F004
010869958775167621000000002141561727063010F004
010869958775167621000000002141421727063010F004
010869958775167621000000002141291727063010F004
010869958775167621000000002141231727063010F004
010869958775167621000000002141641727063010F004
010869958775167621000000002141451727063010F004
010869958775167621000000002141001727063010F004
010869958775167621000000002141081727063010F004
010869958775167621000000002140961727063010F004
010869958775167621000000002141101727063010F004
010869958775167621000000002141091727063010F004
010869958775167621000000002140981727063010F004
010869958775167621000000002141161727063010F004
010869958775167621000000002140891727063010F004
010869958775167621000000002141781727063010F004
010869958775167621000000002051741727063010F003
010869952535117321980910071000761725123110A099678
010869952535117321980910103435021726103110A108430
010869952535117321701100312531171729073110A25901
010869952535117321980910103435121726103110A108430
010869952535117321701100312531371729073110A25901
010869952535117321980910105515261726113010A109187
010869952535117321701100312531471729073110A25901
010869952535117321980910103435041726103110A108430
010869952535117321980910103435101726103110A108430
010869952535117321220100247880271726113010A109655
010869952535117321701100312531271729073110A25901
010869952535117321701100312531481729073110A25901
010869952535117321701100312531381729073110A25901
010869952535117321701100312531071729073110A25901
010869952535117321701100312531081729073110A25901
010869952535117321701100312531181729073110A25901
010869952535117321701100312531281729073110A25901
010869952535117321701100258164671727123110A00031
010869952535117321701100275056251728022910A13540
010869952535117321701100258164521727123110A00031
010869952535117321701100258164371727123110A00031
010869952535117321701100275050121728022910A13540
010869952535117321701100258163821727123110A00031
010869952535117321701100258164591727123110A00031
010869952535117321701100275050781728022910A13540
010869952535117321701100258164691727123110A00031
010869952535117321701100258163841727123110A00031
010869952535117321701100258164511727123110A00031
010869952535117321701100258164261727123110A00031
010869952535117321701100275050171728022910A13540
010869952535117321701100275050671728022910A13540
010869952535117321701100268255501728022910A12856
010869952535117321701100275050501728022910A13540
010869952535117321701100275050371728022910A13540
010869952535117321701100275050621728022910A13540
010869952535117321701100275050081728022910A13540
010869952535117321701100275049981728022910A13540
010869952535117321701100275056151728022910A13540
010869952535117321701100258164771727123110A00031
010869952535117321701100258164301727123110A00031
010869952535117321701100275050471728022910A13540
010869952535117321701100275049861728022910A13540
010869952535117321701100262229621728012910A00652
010869952535117321701100268255491728022910A12856
010869952535117321701100275050701728022910A13540
010869952535117321701100258164391727123110A00031
010869952535117321701100275056141728022910A13540
010869952535117321701100275049871728022910A13540
010869952535117321701100275050811728022910A13540
010869952535117321701100275050511728022910A13540
010869952535117321701100275050101728022910A13540
010869952535117321701100275049881728022910A13540
010869952535117321701100275050821728022910A13540
010869952535117321701100275056241728022910A13540
010869952535117321701100258164381727123110A00031
010869952535117321701100275056521728022910A13540
010869952535117321701100258164751727123110A00031
010869952535117321701100275056761728022910A13540
010869952535117321701100275050271728022910A13540
010869952535117321701100258164681727123110A00031
010869952535117321701100275050541728022910A13540
010869952535117321701100275049921728022910A13540
010869952535117321701100258166591727123110A00031
010869952535117321701100275056801728022910A13540
01086995696200132172563543579009172609301024274036
01086995696200132172555536204209172605311024274023
01086995696200132172555534792909172605311024274023
01086995696200132172555534793709172605311024274023
01086995696200132172555534796009172605311024274023
01086995696200132172563543581009172609301024274036
01086995696200132172563543578409172609301024274036
01086995696200132172563543577809172609301024274036
010869960775052821100000019904321726103110210518026
010869960775052821100000019904221726103110210518026
010869960775052821100000019899841726103110210518026
010869960775052821100000019899951726103110210518026
010869960775052821100000019904411726103110210518026
010869960775052821100000019899871726103110210518026
010869960775052821100000019904081726103110210518026
010869960775052821100000019904311726103110210518026
010869960775052821100000019899811726103110210518026
010869960775052821100000019608671726093010210518021
010869960775052821100000019608631726093010210518021
010869960775052821100000019904481726103110210518026
010869960775052821100000019608541726093010210518021
010869960775052821100000019608641726093010210518021
010869960775052821100000019904421726103110210518026
010869960775052821100000019904361726103110210518026
010869960775052821100000019904111726103110210518026
010869960775052821100000019899671726103110210518026
010869960775052821100000019904181726103110210518026
010869960775052821100000019900021726103110210518026
010869960775052821100000019899931726103110210518026
010869960775052821100000019904171726103110210518026
010869960775052821100000019904251726103110210518026
010869960775052821100000019586351726093010210518021
010869960775052821100000019900041726103110210518026
010869960775052821100000019899681726103110210518026
010869960775052821100000019904451726103110210518026
010869960775052821100000019900051726103110210518026
010869960775052821100000019899761726103110210518026
010869960775052821100000019899851726103110210518026
010869960775052821100000019899741726103110210518026
010869960775052821100000019899711726103110210518026
010869960775052821100000019899781726103110210518026
010869960775052821100000019900031726103110210518026
010869960775052821100000019899901726103110210518026
010869960775052821100000019899921726103110210518026
010869960775052821100000019899831726103110210518026
010869960775052821100000019904581726103110210518026
010869960775052821100000019904381726103110210518026
010869960775052821100000019899821726103110210518026
010869960775052821100000019899701726103110210518026
010869960775052821100000019899731726103110210518026
010869960775052821100000019900011726103110210518026
010869960775052821100000019904331726103110210518026
010869960775052821100000019899941726103110210518026
010869960775052821100000019899691726103110210518026
010869960775052821100000019899891726103110210518026
010869960775052821100000019904431726103110210518026
010869960775052821100000019904371726103110210518026
010869960775052821100000019899861726103110210518026
010869960775052821100000019904091726103110210518026
010869960775052821100000019900001726103110210518026
010869960775052821100000019904351726103110210518026
010869960775052821100000019904841726103110210518026
010869960775052821100000019904391726103110210518026
010869960775052821100000019899791726103110210518026
010869960775052821100000019610861726093010210518021
010869960775052821100000019899981726103110210518026
010869960775052821100000019586271726093010210518021
010869960775052821100000019610921726093010210518021
010869960775052821100000019904231726103110210518026
010869960775052821100000019586321726093010210518021
010869960775052821100000019904161726103110210518026
010869960775052821100000019899991726103110210518026
010869960775052821100000019904291726103110210518026
010869960775052821100000019610901726093010210518021
010869960775052821100000019904851726103110210518026
010869960775052821100000019904201726103110210518026
010869960775052821100000019904461726103110210518026
010869960775052821100000019904301726103110210518026
010869960775052821100000019899801726103110210518026
010869960775052821100000019904271726103110210518026
010869960775052821100000019899961726103110210518026
010869960775052821100000019904241726103110210518026
010869960775052821100000019904441726103110210518026
010869960775052821100000019612331726093010210518021
010869960775052821100000019899911726103110210518026
010869960775052821100000019904141726103110210518026
010869960775052821100000019904861726103110210518026
010869960775052821100000019899971726103110210518026
010869960775052821100000019900061726103110210518026
010869960775052821100000019899881726103110210518026
010869960775052821100000019904121726103110210518026
010869960775052821100000019899721726103110210518026
010869960775052821100000019904401726103110210518026
010869960775052821100000019608551726093010210518021
010869960775052821100000019608721726093010210518021
010869960775052821100000019608561726093010210518021
010869960775052821100000019904471726103110210518026"""

def load_meds():
    with open('data/medications_barcode.json', 'r', encoding='utf-8') as f:
        return json.load(f)

def parse(bc):
    r = {"gtin": None, "serial_number": None, "lot_number": None, "expiry_date": None}
    if not bc: return r
    bc = bc.strip()
    if len(bc) == 13 and bc.isdigit():
        r["gtin"] = bc; r["serial_number"] = f"EAN-{bc}-{uuid.uuid4().hex[:8]}"; return r
    if bc.startswith('01') and len(bc) >= 16:
        r["gtin"] = bc[2:16]; rest = bc[16:]
        if rest.startswith('21'):
            se = len(rest)
            for ai in ['17', '10']:
                idx = rest.find(ai, 2)
                if idx > 2 and idx < se: se = idx
            r["serial_number"] = rest[2:se]; rest = rest[se:]
        if '17' in rest:
            idx = rest.find('17')
            if idx >= 0 and len(rest) >= idx + 8:
                try:
                    e = rest[idx+2:idx+8]
                    r["expiry_date"] = datetime(2000+int(e[0:2]), int(e[2:4]), max(1, int(e[4:6])))
                except: pass
        if '10' in rest:
            idx = rest.find('10')
            if idx >= 0:
                le = len(rest)
                for ai in ['17', '21']:
                    ai_idx = rest.find(ai, idx+2)
                    if ai_idx > idx and ai_idx < le: le = ai_idx
                r["lot_number"] = rest[idx+2:le]
    if not r["serial_number"]: r["serial_number"] = f"RAW-{bc[:20]}"
    return r

def get_name(gtin, db):
    if not gtin: return None
    if gtin in db: return db[gtin]
    if len(gtin) == 14 and gtin.startswith('0') and gtin[1:] in db: return db[gtin[1:]]
    return None

async def main():
    from motor.motor_asyncio import AsyncIOMotorClient
    bcs = [b.strip() for b in ALL.strip().split('\n') if b.strip()]
    client = AsyncIOMotorClient('mongodb+srv://healmedy_user:H3alm3dy2024!@abro.lwzasyg.mongodb.net/')
    db = client['healmedy_hbys']
    meds = load_meds()
    print(f"KALAN: {len(bcs)} karekod")
    res = {"success": 0, "exists": 0}
    sm = defaultdict(lambda: {"name": "", "count": 0})
    for bc in bcs:
        if not bc: continue
        try:
            p = parse(bc)
            g, s = p.get("gtin"), p.get("serial_number")
            if await db.barcode_stock.find_one({"serial_number": s, "gtin": g}):
                res["exists"] += 1; continue
            n = get_name(g, meds) or f"Bilinmeyen ({g[-6:] if g else 'N/A'})"
            sm[g]["name"] = n; sm[g]["count"] += 1
            sid = str(uuid.uuid4())
            await db.barcode_stock.insert_one({
                "_id": sid, "gtin": g or "", "serial_number": s,
                "lot_number": p.get("lot_number"), "expiry_date": p.get("expiry_date"),
                "name": n, "location": "merkez_depo", "location_detail": "Ana Depo",
                "status": "available", "added_at": datetime.utcnow(), "added_by": "bulk_import",
                "added_by_name": "Toplu Ice Aktarma", "raw_barcode": bc
            })
            await db.stock.insert_one({
                "_id": str(uuid.uuid4()), "name": n, "code": g[:8] if g else s[:8],
                "gtin": g, "quantity": 1, "min_quantity": 1, "location": "merkez_depo",
                "location_detail": "Ana Depo", "lot_number": p.get("lot_number"),
                "serial_number": s, "expiry_date": p.get("expiry_date"),
                "qr_code": sid, "unit": "adet", "created_at": datetime.utcnow(),
                "updated_at": datetime.utcnow(), "barcode_stock_id": sid
            })
            res["success"] += 1
        except: pass
    client.close()
    print(f"SONUC: {res['success']} eklendi, {res['exists']} mevcut")
    for g, i in sorted(sm.items(), key=lambda x: x[1]['count'], reverse=True)[:15]:
        print(f"  {i['count']:3d}x {i['name'][:55]}")
    print("TAMAMLANDI!")

if __name__ == "__main__":
    asyncio.run(main())






